---
title: "FY2021 Analysis - Methodology for Fiscal Futures"
author: "Alea Wilbur"
date: "October 2022"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
    df_print: paged
---

```{r eval = FALSE, include=FALSE}
title: "FY2022 Analysis - Methodology for Fiscal Futures "
author: "Alea Wilbur"
date: "October 2022"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
    df_print: paged
```


```{r warning = FALSE, message=FALSE, include=FALSE}


#install.packages("rlang")
#library(rlang)
library(tidyverse)
library(haven)
library(formatR)
library(lubridate)
library(smooth)
library(forecast)
library(scales)
library(kableExtra)
library(ggplot2)
library(readxl)
library(tidyverse)
library(data.table)
library(quantmod)
library(geofacet)
library(janitor)


knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE
                      )
```

# Inspecting new FY21 data files

Data files for closed years have been obtained from IOC.  Source spending data is at the fund-agency-object level and source revenue data is at the fund-agency-source level.  

Revenue File:  
- 671 Fund Numbers  
- 1182 Revenue sources  
- 84 Agencies  

Expenditure File:  
- 709 Funds  
- 106 Agencies - 98 Division Numbers, 315 Division names  


# Variables

__Using the comptrollers variables:__ 

Detail Object is a department classification used by the State to group expenses.

**Object:** e.g. 1100 - Personal Services; 880 - Debt Service; 8813 - Current Maturities-Interest

**Group:** RE-reimbursements; TR-Transfers; 9-Other

**Category:** T - Taxable Bond Fund Payments, 4 - Nonprofit organizations grants; 7 - Personal Services Related

**Type:** T - Statutory Transfers; 1 - Operations; 6 - Permanent Improvements; 8-Debt Service; 9-Refunds

**Class:** ex. 402 - Income Tax Refunds, 407 - Sales Tax Refunds

**Appropriation Category:** 8800 - Debt Service; 1129 - Employee Retirement Paid State


# Data Creation and Cleaning

1. Do the FOIA request
2. In a week or so, they send the expenditure and revenue data as excel files. 
3. Checks whether there are any new agencies, re-used funds etc. Create a list of funds, agencies, fund names, etc. for the new year and compare it to the immediate prior year to identify new funds.
4. Update the funds_ab_in file which shows the use of funds. Use criteria to determine if the new funds should be in or out of the all-funds frame. 
5. Then, download the excel files that are sent to you. 
6. Open and change the names to be consistent with other files such as AGENCYNAME--> agency_name

Combine past years: All revenue files are in a `revenue` folder that I reference when I set the working directory. When adding new fiscal years, put the the newest year of data for revenue and expenditures in their respective folders. 

__Pre-FY2022__

The code chunk below takes the .dta files for all fiscal years before FY 2022 and binds them together.  Variable names were manually changed by past researchers so that they were consistent across years. 

Reads in dta file and leaves fund as a character. No longer have to worry about preserving leading zeros in categories like the fund numbers. State code used to force fund, source, and from_fund to be 4 digits long and preserve leading zeros and fund was 3 digits long with leading zeros.

```{r create-rev-csv, eval = FALSE, include=FALSE}
setwd("C:/Users/aleaw/OneDrive/Desktop/PhD Fall 2021 - Spring 2022/Merriman RA/Fiscal Futures FY2022/revenue")

# does all of stata code lines 1-514 of combining yearly data

allrevfiles22 = list.files(path = "C:/Users/aleaw/OneDrive/Desktop/PhD Fall 2021 - Spring 2022/Merriman RA/Fiscal Futures FY2022/revenue",  pattern = ".dta") %>%  lapply(read_dta) %>% bind_rows
#Fy21: 62295 observations, 13 variables
#FY22: 65094 obs, 13 vars

write_csv(allrevfiles22, "allrevfiles22.csv")




setwd("C:/Users/aleaw/OneDrive/Desktop/PhD Fall 2021 - Spring 2022/Merriman RA/Fiscal Futures FY2022/expenditures")

allexpfiles22 = list.files(path = "C:/Users/aleaw/OneDrive/Desktop/PhD Fall 2021 - Spring 2022/Merriman RA/Fiscal Futures FY2022/expenditures",  pattern = ".dta") %>%  lapply(read_dta) %>% bind_rows

#fy21 213372 observations, 20 variables
# fy22 225587 obs, 21 vars.

write_csv(allexpfiles22, "allexpfiles22.csv")

```
 


Code below reads in the csv files created in chunks above (allrevfiles.csv and allrexpfiles.csv). These files contain all years of data combined into one file BEFORE any recoding is done. Do not use this file for summing categories because it is just an in between step before recoding revenue and expenditure categories. 

```{r readCSVs}
# combined in past chunks called create-rev-csv and create-exp-csv
setwd("C:/Users/aleaw/OneDrive/Desktop/PhD Fall 2021 - Spring 2022/Merriman RA/Fiscal Futures FY2022/Replication-Files")

allrevfiles <- read_csv("allrevfiles22.csv") #combined but not recoded
allexpfiles <- read_csv("allexpfiles22.csv") #combined but not recoded

```

Normally, when your receive the new fiscal year files from the Comptrollers office, you will need to change the variable names so that they are consistent with past years. This is an example of reading in the new file and changing the variable names. 

For FY 2022 and after, .dta files can be avoided entirely and .csv files and R code will be used.All files before this year had been saved and passed on as .dta files for Stata code before the transition to R in Fall 2022  

Example code below: Read in excel file and rename columns so that it plays well with the other years' files.

```{r rename-variables, eval=FALSE}
read_xlsx("Fis_Fut_Rev_2021.xlsx") %>% 
  rename(fy = 'FISCAL YEAR',
         fund = 'FUND #',
         fund_name = 'FUND NAME',
         agency = 'AGENCY #',
         agency_name = 'AGENCY NAME',
         source = 'REVENUE SOURCE #',
         source_name = 'REV SRC NAME',
         receipts = 'REVENUE YTD AMOUNT'
  ) %>%
  # do these come from funds_ab_whatever file?
  mutate(fund_cat = FIND_COLUMN, #create fund_cat column
         fund_cat_name = FIND_NAME) # create fund_cat_name column

read_xlsx("Fis_Fut_Exp_2021.xlsx") %>% 
  rename(fy = 'FISCAL YEAR',
         fund = 'FUND #',
         fund_name = 'FUND NAME',
         agency = 'AGENCY #',
         agency_name = 'AGENCY NAME',
         appr_org = 'DIVISION',
         org_name = 'DIVISION NAME',
         obj_seq_type = 'APPROPRIATION #',
         wh_approp_name = 'APPROPRIATION NAME',
         exp_net_xfer = 'NET OF TRANS AMOUNT',
         expenditure = 'EXPENDED THRI 7/26/22'
  ) %>%
  # do these come from funds_ab_whatever file?
  mutate(data_source = "exp IOC Oct 2021",
         object = ,
         seq = ,
         type = ,
         fund_cat = FIND_COLUMN, #create fund_cat column
         fund_cat_name = FIND_NAME) # create fund_cat_name column

```



Identify new and reused funds for newest fiscal year. Recode funds to take into account different fund numbers/names over the years. Update fund_ab_in_2021.xlsx with any changes from previous fiscal year. 

> Clarify and add steps for identifying new and reused funds.


For funds that were reused once, a 9 replaces the 0 as the first digit. If reused twice, then the first two values are 10.   
- Ex. 0350 --> 9350 because its use changed.   
- Ex. 0367 becomes 10367 because its use has changed twice now. There was fund 0367 originally, then its use changed and it was recoded as 9367, and now it changed again so it is a 10367.  


```{r recode-rev-funds}
# if first character is a 0, replace with a 9

rev_1998_2022 <- allrevfiles %>%
      mutate(fund = ifelse(fy < 2002 & fund %in% c("0730", "0241", "0350", "0367", "0381", "0382", "0526", "0603", "0734", "0913", "0379"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund = ifelse(fy < 2008 & fund %in% c("0027", "0033", "0037", "0058", "0062", "0066", "0075", "0083", "0116", "0119", "0120", "0122", "0148", "0149", "0157", "0158", "0166", "0194", "0201", "0209", "0211", "0217", "0223", "0231", "0234", "0253", "0320", "0503", "0505", "0512", "0516", "0531", "0532", "0533", "0547", "0563", "0579", "0591", "0606", "0616", "0624", "0659", "0662", "0665", "0676", "0710", 
"0068", "0076", "0115", "0119", "0168", "0182", "0199", "0241", "0307", "0506", "0509", "0513"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund = ifelse(fy < 2016 & fund %in% c("0263", "0399", "0409"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2017 & fund == "0364", str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2018 & fund %in% c("0818", "0767", "0671", "0593", "0578"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund = ifelse(fy>1999 & fy < 2018 & fund == "0231", "10231", fund) ) %>%
  
  mutate(fund = ifelse(fy < 2019 & fund %in% c("0161", "0489", "0500", "0612", "0893", "0766"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2020 & fund %in% c("0254", "0304", "0324", "0610", "0887", "0908", "0939", "0968"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2021 & fund %in% c("0255", "0325", "0348", "0967", "0972"), str_replace(fund, "0","9"), fund) )

```

Expenditure recoding: 

```{r recode-exp-funds}
# if first character is a 0, replace with a 9

exp_1998_2022 <- allexpfiles %>%
      mutate(fund = ifelse(fy < 2002 & fund %in% c("0730", "0241", "0350", "0367", "0381", "0382", "0526", "0603", "0734", "0913", "0379"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund = ifelse(fy < 2008 & fund %in% c("0027", "0033", "0037", "0058", "0062", "0066", "0075", "0083", "0116", "0119", "0120", "0122", "0148", "0149", "0157", "0158", "0166", "0194", "0201", "0209", "0211", "0217", "0223", "0231", "0234", "0253", "0320", "0503", "0505", "0512", "0516", "0531", "0532", "0533", "0547", "0563", "0579", "0591", "0606", "0616", "0624", "0659", "0662", "0665", "0676", "0710", 
"0068", "0076", "0115", "0119", "0168", "0182", "0199", "0241", "0307", "0506", "0509", "0513"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund = ifelse(fy < 2016 & fund %in% c("0263", "0399", "0409"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2017 & fund == "0364", str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2018 & fund %in% c("0818", "0767", "0671", "0593", "0578"), str_replace(fund, "0","9"), fund)) %>%
  mutate(fund = ifelse(fy>1999 & fy < 2018 & fund == "0231", "10231", fund) ) %>%
  
  mutate(fund = ifelse(fy < 2019 & fund %in% c("0161", "0489", "0500", "0612", "0893", "0766"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2020 & fund %in% c("0254", "0304", "0324", "0610", "0887", "0908", "0939", "0968"), str_replace(fund, "0","9"), fund)) %>%
  
  mutate(fund =  ifelse(fy < 2021 & fund %in% c("0255", "0325", "0348", "0967", "0972"), str_replace(fund, "0","9"), fund))  
  
```


```{r create-exp_temp, warning = FALSE, message = FALSE}
funds_ab_in_2021 = readxl::read_excel("C:/Users/aleaw/OneDrive/Desktop/PhD Fall 2021 - Spring 2022/Merriman RA/Fiscal Futures FY2022/Replication-Files/funds_ab_in_2022.xlsx")


exp_temp <- exp_1998_2022 %>% 
  arrange(fund, fy) %>%
  filter(expenditure != 0) %>% # keeps everything that is not zero
# join  funds_ab_in_2021  to exp_temp
 left_join(funds_ab_in_2021, by = "fund")  # matches most recent fund number 

```

- the initial combined years of data are saved as dataframes named `exp_1998_2021` and `rev_1998_2021`. These are then saved as exp_temp and rev_temp while recoding variables. This is BEFORE category groups are created and cleaned below. Only a temporary file, do not use for analysis. 


```{r remove-all_obs_df, include=FALSE}
# remove from computer memory to free up space (in case your computer needs it)
rm(allexpfiles)
rm(allrevfiles)
```

Update Agencies: Early agencies replaced by successors
```{r agencies-exp}
# recodes old agency numbers to consistent agency number
exp_temp <- exp_temp %>% 
  mutate(agency = case_when(
    (agency=="438"| agency=="475" |agency == "505") ~ "440",
    # financial institution &  professional regulation &
     # banks and real estate  --> coded as  Business and Professional regulation
    agency == "473" ~ "588", # nuclear safety moved into IEMA --> Public Safety
    (agency =="531" | agency =="577") ~ "532", # coded as EPA
    (agency =="556" | agency == "538") ~ "406", # coded as agriculture
    agency == "560" ~ "592", # IL finance authority (fire trucks and agriculture stuff)to state fire marshal
    agency == "570" & fund == "0011" ~ "494",   # city of Chicago road fund to transportation
    TRUE ~ (as.character(agency)))) 
```

# Modify Expenditure File

### Tax refunds 

Aggregate expenditures: Save tax refunds as negative revenue. Code refunds to match the rev_type codes (02=income taxes, 03 = corporate income taxes, 06=sales tax, 09=motor fuel tax, 24=insurance taxes and fees, 35 = all other tax refunds)


```{r tax-refunds}
## negative revenue becomes tax refunds

tax_refund_long <- exp_temp %>% 
 # fund != "0401" # removes State Trust Funds
  filter(fund != "0401" & (object=="9910"|object=="9921"|object=="9923"|object=="9925")) %>%
  # keeps these objects which represent revenue, insurance, treasurer,and financial and professional reg tax refunds
  mutate(refund = case_when(
    fund=="0278" & sequence == "00" ~ "02",   # for income tax refund
    fund=="0278" & sequence == "01" ~ "03", # tax administration and enforcement and tax operations become corporate income tax refund
     fund == "0278" & sequence == "02" ~ "02",
    object=="9921" ~ "21", # inheritance tax and estate tax refund appropriation
    object=="9923" ~ "09", # motor fuel tax refunds
    obj_seq_type == "99250055" ~ "06", # sales tax refund
    fund=="0378" & object=="9925" ~ "24", # insurance privilege tax refund
    fund=="0001" & object=="9925" ~ "35", #all other taxes
      T ~ "CHECK")) # if none of the items above apply to the observations, then code them as CHECK 

    
exp_temp <- left_join(exp_temp, tax_refund_long) %>%
  mutate(refund = ifelse(is.na(refund),"not refund", as.character(refund)))

tax_refund <- tax_refund_long %>% 
  group_by(refund, fy)%>%
  summarize(refund_amount = sum(expenditure, na.rm = TRUE)/1000000) %>%
  pivot_wider(names_from = refund, values_from = refund_amount, names_prefix = "ref_") %>%
  mutate_all(~replace_na(.,0)) %>%
  arrange(fy)


# remove the items we recoded in tax_refund_long
exp_temp <- exp_temp %>% filter(refund == "not refund")

#should be 156 fewer observations

```

`tax_refund` will ultimately be removed from expenditure totals and instead subtracted from revenue totals (since they were tax refunds).


### Pension Expenditures


State payments to the following pension systems:  

• Teachers Retirement System (TRS)  
  - New POB bond in 2019: Accelerated Bond Fund paid benefits in advance as lump sum
• State Employee Retirement System (SERS)  
• State University Retirement System (SURS)  
• Judges Retirement System (JRS)  
• General Assembly Retirement System (GARS)  

Old code comments: "You also must consider pension obligated bonds (POB) - funded contributions."  
  - Pension obligation bonds (POBs) are taxable bonds that some state and local governments have issued as part of an overall strategy to fund the unfunded portion of their pension liabilities by creating debt.

_DONE: Change POB fund == 0325 to 0 in fund_ab_YEAR file to exclude it._

__Check what is included in pensions:__

- object = 4431 catches most pension items
- object = 1298 is purchase of investments and is excluded from analysis except for a couple exceptions during 2010 and 2011  

```{r pension-check, eval = FALSE, include=FALSE}
# check what is being included in pensions

pension_check <- exp_temp %>% 
  mutate(pension = case_when( 
     #   (object=="4431" | (object>"1159" & object<"1166") ) ~ 1, # 4431 = easy to find pension items
       (object=="4431" | (obj_seq_type > "11590000" & obj_seq_type < "11660000") ) ~ 1, 

    # objects 1159 to 1166 are all considered Retirement by Comptroller 
    # object == 1167 also appears to be Other Retirement but isn't used yet
            TRUE ~ 0)) %>% 
  
  mutate(pension = case_when(     # objects were weird for 2010 and 2011
   (object=="4431" & fund=="0473" & (fy==2010 | fy==2011)) ~ 3, # teachers retirement system,  
  #  obj_seq_type == "44310055" ~ 3, # teachers retirement system in 2010 and 2011. 
   (object=="1298" & (fy==2010 | fy==2011) & (fund=="0477" | fund=="0479" | fund=="0481")) ~ 3, # judges retirement 
   # obj_seq_type == "12980055" ~ 3, # judge retirement contriubtions during 2010 and 2011
    TRUE ~ pension)) %>% 
  filter(pension > 0 )


pension_check 

# write_csv(pension_check, "pension_check.csv")

## taking care of Pension Obligation Bond proceeds

pension_check <- pension_check %>% 
  # change object for 2010 and 2011, retirement expenditures were bond proceeds
  mutate(object = ifelse((pension == 3 & in_ff == "0"), "4431", as.character(object))) %>% # changes weird teacher & judge retirement system  pensions object to normal pension object 4431
  mutate(pension =  ifelse(pension == 1 & in_ff == "0", 2, pension)) %>% # coded as 2 if it was supposed to be excluded due to being bond proceeds ?
  mutate(in_ff = ifelse((pension ==2 | pension ==3), "1", as.character(in_ff)))


# create file with all pension items to find any mistakes
#pension_check %>% write_csv("all_pensions.csv")

table(pension_check$pension)

pension_check %>% filter(pension == 2 ) # subtract these from expenditures OR add them as an "Other Revenue" source at end of code?

pension_check %>% filter(pension == 2 ) %>% group_by(fy) %>% summarise(pob_sum = sum(expenditure))

```


Modify exp_temp and move all pension contributions to their own group (901):
```{r pensions}
exp_temp <-  exp_temp %>% 
  arrange(fund) %>%
  mutate(pension = case_when( 
    
  # objects were weird for 2010 and 2011 for teacher and judge retirement system
  (object=="4431" & fund=="0473" &  (fy==2010 | fy==2011)) ~ 3, # teachers retirement system, 
  (object=="1298" & (fy==2010 | fy==2011) & (fund=="0477" | fund=="0479" | fund=="0481")) ~ 3, #judges retirement
 
  (object=="4431" | (object>"1159" & object<"1166") & fund != "0183" & fund != "0193"  ) ~ 1, # 4431 = easy to find pension items
   # objects 1159 to 1166 are all considered Retirement by Comptroller 
  # object == 1167 also appears to be Other Retirement but isn't used yet
                                        TRUE ~ 0)) 

table(exp_temp$pension) # same number of total observations > 0 as pension_check
```

~~POB-funded contributions to JRS, SERS, GARS, and TRS must be accounted for in a different way:Pension = 2 represents retirement pension payments paid for with POB-funded contributions that were excluded from the fiscal futures analysis by default ( in_ff was 0 because bond financed funds are not sustainable cash flows) but should be included and added to the revenue side under "Other Revenues" in later steps.~~  <-- No longer done.


Description of Pension Obligation Acceleration Bond at this [link](https://www.ilga.gov/legislation/ilcs/documents/003003300K7.7.htm)

```{r pensions-POB}
 
exp_temp <- exp_temp %>% 
  # change object for 2010 and 2011, retirement expenditures were bond proceeds
  mutate(object = ifelse((pension == 3 & in_ff == "0"), "4431", object)) %>% 
  # changes weird teacher & judge retirement system  pensions object to normal pension object 4431
  mutate(pension =  ifelse(pension ==1 & in_ff == "0", 2, pension)) %>% # coded as 2 if it was supposed to be excluded. 
  mutate(in_ff = ifelse((pension ==2 | pension ==3 ), "1", in_ff))

table(exp_temp$pension) 


# all other pensions objects (1 and 3) codes get agency code 901 for State Pension Contributions
exp_temp <- exp_temp %>% 
  mutate(agency = ifelse(pension>0, "901", as.character(agency)),
         agency_name = ifelse(agency == "901", "State Pension Contributions", as.character(agency_name)))


```


- *DONE* add "& fund !=0183" to teacher retirement pensions code below  - FY22 AWM     
  - fund = 0183 from 1999 to 2005, org_name = Serve America, fund_name is post traumatic stress awareness

### Drop Interfund transfers

- object == 1993 is for interfund cash transfers  
- agency == 799 is for statutory transfers  
- object == 1298 is for purchase of investments and is not spending EXCEPT for pensions in 2010 and 2011 (and were recoded already to object == "4431"). Over 168,000 observations remain.  

```{r drop-transfers}

transfers_drop <- exp_temp %>% filter(
  agency == "799" | # statutory transfers
           object == "1993" |  # interfund cash transfers
           object == "1298") # purchase of investments

exp_temp <- anti_join(exp_temp, transfers_drop)


```


### State employee healthcare costs


State Employee Health Care = Sum of expenditures for "health care coverage as elected by members per state employees group insurance act." The payments are made from the Health Insurance Reserve Fund. We subtract the share that came from employee contributions. Employee contributions are not considered a revenue source or an expenditure in our analysis.


Fund = 0457 is "Group insurance premium", in_ff = 1
Fund = 0193 is "Local govt health insurance reserve", in=ff = 0
fund = 0477 is "Community College Health Insurance", in=ff = 0.   
- had large amount in early years
Fund = 0907 = health insurance reserve, in_ff = 1
Fund = 9939 is "group self-insurers' insolv", in_ff = 1
Fund = 0940 is Self-Insurers security, in_ff = 0
Fund = 0739 is Group Workers Comp Pool Insol, in_ff = 1

Employer contributions for group insurance are excluded to avoid double counting the cost of healthcare.

All employer contributions are coded as object = 1180. 

- eehc = 0 means it is NOT a state healthcare cost but it is an employer contribution of some type to some fund   
- eehc = 1 means it is a state employee healthcare cost and it is an employer contribution to health insurance

```{r healthcare-employee-contributions, eval=FALSE, include = FALSE}

# examine group insurance totals per year
group_ins <- exp_temp %>% 
  mutate(eehc = ifelse(
    # group insurance contributions for 1998-2005 and 2013-present
   fund == "0001" & (object == "1180" | object =="1900") & agency == "416" & appr_org=="20", 0, 1) )%>% 
  mutate(eehc = ifelse(
    # group insurance contributions for 2006-2012
    fund == "0001" & object == "1180" & agency == "478" & appr_org=="80", 0, eehc) )%>%
  filter(eehc == 0) %>% 
    group_by(fy) %>% 
    summarize(dropped_group_premiums = sum(expenditure))

# examine healthcare cost items total per year
healthcare_costs <- exp_temp %>% 
  mutate(eehc = ifelse(
    # group insurance contributions for 1998-2005 and 2013-present
   fund == "0001" & (object == "1180" | object =="1900") & agency == "416" & appr_org=="20", 0, 1) )%>% 
  mutate(eehc = ifelse(
    # group insurance contributions for 2006-2012
    fund == "0001" & object == "1180" & agency == "478" & appr_org=="80", 0, eehc) )%>%
  mutate(expenditure = ifelse(eehc==0, 0, expenditure)) %>%    
  group_by(fy) %>% 
    summarize(cost_of_provision = sum(expenditure))

exp_temp_check <- exp_temp %>% 
  mutate(agency = case_when(   # turns specific items into State Employee Healthcare (agency=904)
      fund=="0907" & (agency=="416" & appr_org=="20") ~ "904",   # central management Bureau of benefits using health insurance reserve 
      fund=="0907" & (agency=="478" & appr_org=="80") ~ "904",   # agency = 478: healthcare & family services using health insurance reserve - stopped using this in 2012
    #  fund=="0001" & appr_org=="20" & object=="1900" & agency=="416" & (fy>2002 & fy<2006) ~ "904",
      
    #  fund=="0001" & appr_org=="20" & object=="1900" & agency=="416" & (fy>2020) ~ "904",
      
    #  obj_seq_type == "19000000" & wh_approp_name == "GROUP INSURANCE" & (fy>2020) ~ "904",

      TRUE ~ as.character(agency))) %>%
  
  mutate(agency_name = ifelse(agency == "904", "STATE EMPLOYEE HEALTHCARE", as.character(agency_name)),
         group = ifelse(agency == "904", "904", as.character(agency))) %>% # creates group variable
filter(group == "904") %>% group_by(fy) %>% summarise(healthcare_cost = sum(expenditure))

exp_temp_check

# Looks good, Sept 28 AWM
```

if observation is a group insurance contribution, then the expenditure amount is set to $0 (essentially dropped from analysis)

```{r eehc1}
#if observation is a group insurance contribution, then the expenditure amount is set to $0 (essentially dropped from analysis)
exp_temp <- exp_temp %>% 
  mutate(eehc = ifelse(
    # group insurance contributions for 1998-2005 and 2013-present
   fund == "0001" & (object == "1180" | object =="1900") & agency == "416" & appr_org=="20", 0, 1) )%>% 
  mutate(eehc = ifelse(
    # group insurance contributions for 2006-2012
    fund == "0001" & object == "1180" & agency == "478" & appr_org=="80", 0, eehc) )%>%
       # group insurance contributions from road fund
  # coded with 1900 for some reason??
    mutate(eehc = ifelse(
      fund == "0011" & object == "1900" & agency == "416" & appr_org=="20", 0, eehc) ) %>%
  
  mutate(expenditure = ifelse(eehc=="0", 0, expenditure)) %>%
  mutate(agency = case_when(   # turns specific items into State Employee Healthcare (agency=904)
      fund=="0907" & (agency=="416" & appr_org=="20") ~ "904",   # central management Bureau of benefits using health insurance reserve 
      fund=="0907" & (agency=="478" & appr_org=="80") ~ "904",   # agency = 478: healthcare & family services using health insurance reserve - stopped using this in 2012
      TRUE ~ as.character(agency))) %>%
  mutate(agency_name = ifelse(agency == "904", "STATE EMPLOYEE HEALTHCARE", as.character(agency_name)),
         in_ff = ifelse( agency == "904", 1, in_ff),
         group = ifelse(agency == "904", "904", as.character(agency)))  # creates group variable

# Default group = agency number

healthcare_costs <- exp_temp %>% filter(group == "904")

healthcare_costs %>% group_by(fy) %>% 
  summarise(healthcare_cost = sum(expenditure)) %>% arrange(-fy)


exp_temp <- anti_join(exp_temp, healthcare_costs) %>% 
  mutate(expenditure = ifelse(object == "1180", 0, expenditure))

healthcare_costs_yearly <- healthcare_costs %>% 
  group_by(fy, group) %>% 
  summarise(healthcare_cost = sum(expenditure, na.rm = TRUE)/1000000) %>% select(-group)


```

> This code chunk above for dealing with group insurance means that healthcare costs need to be added to expenditures after other group names are assigned. Then employee contributions/insurance premiums from the revenue side need to be subtracted from the total cost of employee healthcare for the net cost.


### Local Transfers

Separate transfers to local from parent agencies that come from DOR(492) or Transportation (494). Treats muni revenue transfers as expenditures, not negative revenue.

The share of certain taxes levied state-wide at a common rate and then transferred to local governments. (Purely local-option taxes levied by specific local governments with the state acting as collection agent are not included.)

The five corresponding revenue items are:  

• Local share of Personal Income Tax   
• Local share of General Sales Tax   
• Personal Property Replacement Tax on Business Income  
• Personal Property Replacement Tax on Public Utilities  
• Local share of Motor Fuel Tax 
  - Transportation Renewal Fund 0952

> Completed: Add the mft mentioned in GOMB email to code

```{r transfers-to-local}
exp_temp <- exp_temp %>% mutate(
  agency = case_when(fund=="0515" & object=="4470" & type=="08" ~ "971", # income tax 
                     fund=="0515" & object=="4491" & type=="08" & sequence=="00" ~ "971", 
                     fund=="0802" & object=="4491" ~ "972", #pprt transfer
                     fund=="0515" & object=="4491" & type=="08" & sequence=="01" ~ "976", #gst to local
                     fund=="0627" & object=="4472"~ "976" ,
                     fund=="0648" & object=="4472" ~ "976",
                     fund=="0515" & object=="4470" & type=="00" ~ "976",
                    object=="4491" & (fund=="0188"|fund=="0189") ~ "976",
                     fund=="0187" & object=="4470" ~ "976",
                     fund=="0186" & object=="4470" ~ "976",
                    object=="4491" & (fund=="0413"|fund=="0414"|fund=="0415")  ~ "975", #mft to local
                  fund == "0952"~ "975", # Added Sept 29 2022 AWM. Transportation Renewal MFT
                    TRUE ~ as.character(agency)),
  
  agency_name = case_when(agency == "971"~ "INCOME TAX 1/10 TO LOCAL",
                          agency == "972" ~ "PPRT TRANSFER TO LOCAL",
                          agency == "976" ~ "GST TO LOCAL",
                          agency == "975" ~ "MFT TO LOCAL",
                          TRUE~as.character(agency_name)),
  group = ifelse(agency>"970" & agency < "977", as.character(agency), as.character(group)))


table(exp_temp$group)
```


```{r drop-local-transfers}
transfers_long <- exp_temp %>% 
  filter(group == "971" |group == "972" | group == "975" | group == "976")

transfers <- transfers_long %>%
  group_by(fy, group ) %>%
  summarize(sum_expenditure = sum(expenditure)/1000000) %>%
  pivot_wider(names_from = "group", values_from = "sum_expenditure", names_prefix = "exp_" )

exp_temp <- anti_join(exp_temp, transfers_long)


dropped_inff_0 <- exp_temp %>% filter(in_ff == 0)

exp_temp <- exp_temp %>% filter(in_ff == 1) # drops in_ff = 0 funds AFTER dealing with net-revenue above

```


### Debt Service


Debt Service expenditures include interest payment on both short-term and long-term debt. We do not include escrow or principal payments. 

**Decision from Sept 30 2022:**

We are no longer including short term principal payments as a cost; only interest on short term borrowing is a cost. Pre FY22 and the FY21 correction, we did include an escrow payment and principle payments as costs but not bond proceeds as revenues. This caused expenditures to be inflated because we were essentially counting debt twice - the principle payment and whatever the money was spent on in other expenditure categories, which was incorrect. 

- Include interest for long-term debt that likely funds capital projects.  

8813 interest **INCLUDE AS COST**  
8811 is for principle **EXCLUDE from analysis**  
8841 is for escrow payments **EXCLUDE from analysis**  
8800 is for capital projects (including the Tollway) **INCLUDE as cost - Note: debt principle and interest are both included because they are combined in the data observations; bond proceeds are not considered a revenue source**  


- ~~Exclude:~~ Bond principle payments: obj_seq_type == 88110008   
  - **Exclude based on Merriman's meeting. Run it both ways to compare output to make sure we made the correct decision.**
- Exclude: Short term borrowing principle: obj_seq_type == 88110108  
  - except for 2021 and 2022 which have GO Bond principle under this code????
  - based on the numbers, I think it is still short term principle with wrong appropriation name
- Include: General Obligation Bond Interest: obj_seq_type == 88130000 & 88130008  
- Include: Interest for short-term borrowing: 88130108
- Exclude: Escrow payment == 88410008
- Include: Build IL Bonds principal AND interest 
  - Tollway is obj_seq_type == 88000055, filter out fund == 0455 to avoid tollway debt  
  - fund == 0455 is the IL State Toll Highway fund, items mostly for operations and maintenance

```{r tollway, include = FALSE, eval=FALSE}
tollway <- exp_temp %>% filter(fund == "0455")
tollway_debt <- exp_temp %>%filter(object == "8800")

#tollway debt principal and interest
exp_temp %>%filter(object == "8800") %>% group_by(fy) %>% summarize(sum=sum(expenditure)) %>% arrange(-fy)


rev_temp <- inner_join(rev_1998_2022, funds_ab_in_2022, by = "fund") %>% arrange(source)

# look at Illinois tollway bond proceeds and debt service: 
# rev_temp %>% filter(fund == "0455") # examine items in fund 0455
exp_temp %>% filter(fund == "0455") %>% group_by(fy) %>% summarize(sum = sum(expenditure)) %>% arrange(-fy)

rev_temp %>% filter(fund == "0455") %>% group_by(fy) %>% summarize(sum = sum(receipts)) %>% arrange(-fy)


# Tollway agency expenditures = SAME as filtering by fund == 0455
#tollway<-exp_temp %>% filter(agency == "557")
#exp_temp %>% filter(agency == "557") %>% group_by(fy) %>% summarize(sum = sum(expenditure)) %>% arrange(-fy)

```

Filtering for interest on short term borrowing and GO bonds (8813_ _ _ _) and GO bond principal amounts (88130008).  
- object == 8813 is for interest but obj_seq_type is used just to be more specific below.   

```{r}

# GO bond principal and GO bond interest
GObond_debt <- exp_temp %>% 
  filter(obj_seq_type == "88110008" |obj_seq_type == "88130000" | obj_seq_type == "88130008") %>% 
  group_by(fy, obj_seq_type) %>% 
  summarize(sum = sum(expenditure, na.rm=TRUE)) %>% 
  pivot_wider(names_from = obj_seq_type, values_from = sum) %>% 
  mutate(principal = `88110008`,
         interest = sum(`88130008`+`88130000`, na.rm = TRUE),
         ratio = (as.numeric(interest)/as.numeric(principal)))

GObond_debt %>% select(principal, interest, ratio) %>%
  mutate(across(principal:interest, ~format(., big.mark= ",", scientific = F)))

GObond_debt %>% ggplot() + 
  geom_line(aes(x=fy, y=principal, color = "Principal"))+ 
  geom_line(aes(x=fy, y=interest, color = "Interest"))

# short term borrowing, first observation is in 2004?
short_debt <- exp_temp %>% 
  filter(obj_seq_type == 88110108 |obj_seq_type == 88130108) %>% 
  group_by(fy, obj_seq_type) %>% 
  summarize(sum = sum(expenditure, na.rm=TRUE)) %>% 
  pivot_wider(names_from = obj_seq_type, values_from = sum) %>% 
  mutate(principal = `88110108`,
         interest = `88130108`,
         ratio = (as.numeric(interest)/as.numeric(principal)))

short_debt %>% select(principal, interest, ratio) %>%
  mutate(across(principal:interest, ~format(., big.mark= ",",  scientific = F)))

short_debt %>% ggplot() + 
  geom_col(aes(x=fy, y=principal/1000000, fill = "Principal"))+ 
  geom_col(aes(x=fy, y=interest/1000000, fill = "Interest")) + 
  labs(title = "Short Term Borrowing: Principal and Interest Payments")

capitalprojects <- exp_temp %>%filter(object == "8800")


all_debt <- exp_temp %>% 
  filter(fund != "0455" & (object == "8811" |object == "8813" | object == "8800") )%>% 
  group_by(fy, object) %>% 
  summarize(sum = sum(expenditure, na.rm=TRUE)) %>% 
  pivot_wider(names_from = object, values_from = sum) %>% 
  mutate(principal = `8811`,
         interest = `8813`,
         BuildIL = `8800`,
         ratio = (as.numeric(interest)/as.numeric(principal)))

all_debt %>% select(principal, interest, BuildIL, ratio) %>%
  mutate(across(principal:BuildIL, ~format(., big.mark= ",", scientific = F)))

all_debt %>% ggplot() + 
  geom_line(aes(x=fy, y=principal/1000000, color = "Principal"))+ 
  geom_line(aes(x=fy, y=interest/1000000, color = "Interest"))+
  geom_line(aes(x=fy, y = BuildIL / 1000000, color = "Build IL Bonds"))+
  labs(y = "Debt ($Millions)", title = "Short term borrowing and GO Bonds",
       subtitle = "Principal and Interest payments")


```

Capital projects include the IL Civic Center and Build Illinois Bonds. Tollway principal and interest has been dropped from Debt Service but is counted in Tollway Expenditure Cost.

```{r debt-service}
debt_drop <- exp_temp %>% 
  filter(object == "8841" |  object == "8811")  
# escrow  OR  principle

#debt_drop %>% group_by(fy) %>% summarize(sum = sum(expenditure)) %>% arrange(-fy)


debt_keep <- exp_temp %>% 
  filter(fund != "0455" & (object == "8813" | object == "8800" )) 
# examine the debt costs we want to include

#debt_keep %>% group_by(fy) %>% summarize(sum = sum(expenditure)) %>% arrange(-fy) 


exp_temp <- anti_join(exp_temp, debt_drop) 
exp_temp <- anti_join(exp_temp, debt_keep)

debt_keep <- debt_keep %>%
  mutate(
    agency = ifelse(fund != "0455" & (object == "8813" | object == "8800"), "903", as.character(agency)),
    group = ifelse(fund != "0455" & (object == "8813" | object == "8800"), "903", as.character(group)),
    in_ff = ifelse(group == "903", 1, as.character(in_ff)))

debt_keep_yearly <- debt_keep %>% group_by(fy, group) %>% summarize(debt_cost = sum(expenditure,na.rm=TRUE)/1000000) %>% select(-group)

```

### Medicaid

__Medicaid.__ That portion of the Healthcare and Family Services (or Public Aid in earlier years, agency code 478) budget for Medical (appr_organization code 65) for awards and grants (object codes 4400 and 4900).  

> State CURE will remain in the Medicaid expenditure category due to the nature of it being federal funds providing public health services and funding to locations that provide public services.

- Uses same appropriation name of "HEALTHCARE PROVIDER RELIEF" and fund == 0793 and obj_seq_type == 49000000. So can defend the "mistake" of including healthcare provider relief as Medicaid expenditure. 


```{r Medicaid-check, include = FALSE, eval=FALSE}
medicaid_check <- exp_temp %>% filter(agency=="478" & (appr_org=="01" | appr_org == "65" | appr_org=="88") & (object=="4900" | object=="4400"))
# This includes the State CURE fund

medicaid_check %>% group_by(fy) %>% summarize(sum = sum(expenditure)) %>% arrange(-fy)  # looks good I think AWM

# if we want state CURE as public health or other group number
# exp_temp <- exp_temp %>% mutate(group = if_else(fund == "0324" & agency=="478" & appr_org == "65" & object=="4900", "478", as.character(group)))
```


## Add Fiscal Future group codes

```{r group-codes}


exp_temp <- exp_temp %>%
  #mutate(agency = as.numeric(agency) ) %>%
  # arrange(agency)%>%
  mutate(
    group = case_when(
      agency>"100"& agency<"200" ~ "910", # legislative
      
      agency == "528"  | (agency>"200" & agency<"300") ~ "920", # judicial
      pension>0  ~ "901", # pensions
      (agency>"309" & agency<"400") ~ "930",    # elected officers
      
      agency == "586" ~ "959", # create new K-12 group

      agency=="402" | agency=="418" | agency=="478" | agency=="444" | agency=="482" ~ as.character(agency), # aging, CFS, HFS, human services, public health
      T ~ as.character(group))
    ) %>%      

  
  mutate(group = case_when(
    agency=="478" & (appr_org=="01" | appr_org == "65" | appr_org=="88") & (object=="4900" | object=="4400") ~ "945", # separates CHIP from health and human services and saves it as Medicaid
    
    agency == "586" & fund == "0355" ~ "945",  # 586 (Board of Edu) has special education which is part of medicaid
    
    # OLD CODE: agency == "586" & appr_org == "18" ~ "945", # Spec. Edu Medicaid Matching
    
    agency=="425" | agency=="466" | agency=="546" | agency=="569" | agency=="578" | agency=="583" | agency=="591" | agency=="592" | agency=="493" | agency=="588" ~ "941", # public safety & Corrections
    
    agency=="420" | agency=="494" |  agency=="406" | agency=="557" ~ as.character(agency), # econ devt & infra, tollway
    
    agency=="511" | agency=="554" | agency=="574" | agency=="598" ~ "946",  # Capital improvement
    
    agency=="422" | agency=="532" ~ as.character(agency), # environment & nat. resources
    
    agency=="440" | agency=="446" | agency=="524" | agency=="563"  ~ "944", # business regulation
    
    agency=="492" ~ "492", # revenue
    
    agency == "416" ~ "416", # central management services
    agency=="448" & fy > 2016 ~ "416", #add DoIT to central management 
    
    T ~ as.character(group))) %>%
  
  
  mutate(group = case_when(
    agency=="684" | agency=="691"  ~ as.character(agency),
    
    agency=="692" | agency=="695" | (agency>"599" & agency<"677") ~ "960", # higher education
    
    agency=="427"  ~ as.character(agency), # employment security
    
    agency=="507"|  agency=="442" | agency=="445" | agency=="452" |agency=="458" | agency=="497" ~ "948", # other departments
    
    # other boards & Commissions
    agency=="503" | agency=="509" | agency=="510" | agency=="565" |agency=="517" | agency=="525" | agency=="526" | agency=="529" | agency=="537" | agency=="541" | agency=="542" | agency=="548" |  agency=="555" | agency=="558" | agency=="559" | agency=="562" | agency=="564" | agency=="568" | agency=="579" | agency=="580" | agency=="587" | agency=="590" | agency=="527" | agency=="585" | agency=="567" | agency=="571" | agency=="575" | agency=="540" | agency=="576" | agency=="564" | agency=="534" | agency=="520" | agency=="506" | agency == "533" ~ "949", 
    
    # non-pension expenditures of retirement funds moved to "Other Departments"
    # should have removed pension expenditures already from exp_temp in Pensions step above
    agency=="131" | agency=="275" | agency=="589" |agency=="593"|agency=="594"|agency=="693" ~ "948",
    
    T ~ as.character(group))) %>%

  mutate(group_name = 
           case_when(
             group == "416" ~ "Central Management",
             group == "478" ~ "Healthcare and Family Services",
             group == "482" ~ "Public Health",
             group == "900" ~ "NOT IN FRAME",
             group == "901" ~ "STATE PENSION CONTRIBUTION",
             group == "903" ~ "DEBT SERVICE",
             group == "910" ~ "LEGISLATIVE"  ,
             group == "920" ~ "JUDICIAL" ,
             group == "930" ~ "ELECTED OFFICERS" , 
             group == "940" ~ "OTHER HEALTH-RELATED", 
             group == "941" ~ "PUBLIC SAFETY" ,
             group == "942" ~ "ECON DEVT & INFRASTRUCTURE" ,
             group == "943" ~ "CENTRAL SERVICES",
             group == "944" ~ "BUS & PROFESSION REGULATION" ,
             group == "945" ~ "MEDICAID" ,
             group == "946" ~ "CAPITAL IMPROVEMENT" , 
             group == "948" ~ "OTHER DEPARTMENTS" ,
             group == "949" ~ "OTHER BOARDS & COMMISSIONS" ,
             group == "959" ~ "K-12 EDUCATION" ,
             group == "960" ~ "UNIVERSITY EDUCATION" ,
             group == agency ~ as.character(group),
             TRUE ~ "Check name"),
         year = fy)

exp_temp %>% filter(group_name == "Check name")

#write_csv(exp_temp, "all_expenditures_recoded.csv")

```


All expenditures recoded but not aggregated: Allows for inspection of individual expenditures within larger categories. This stage of the data is extremely useful for investigating almost all questions we have about the data. 

Note that these are the raw figures BEFORE we take the additional steps:   

- Subtract employee insurance premiums from State Employee Healthcare expenditures  
- Subtract tax refunds from tax revenues by revenue type.  
- Subtract employee pension contributions (originally a dropped revenue) from State Pension expenditures

- **NOT DOING ANYMORE**: ~~Add employee health costs and certain pension contributions to All Other Revenues~~ 




# Modify  Revenue data


Included: 

2. Individual Income Tax
3. Corp. Income Tax
6. Sales Tax
9. Motor Fuel Tax.
12. Public Utility Taxes
15. Cigarette Taxes
18. Liquor Gallonage Taxes
21.. Inheritance Tax
24. Insurance Taxes & Fees & Licenses
27. Corp. Franchise Taxes and Fees
28. Medical Cannabis
29. Recreational Cannabis
30. Horse Racing Taxes & Fees
31. Medical Assessments
32. Garnishment - Levies
33. Lottery Receipts
35. Other Taxes
36. Receipts from Revenue Producing
39. Licenses, Fees, and Registrations

Created:
57. Federal
58. Federal
59. Federal


Revenue Categories not included in Fiscal Futures:   
- 32.  Garnishment-Levies.  (State is fiduciary, not beneficiary.)  
- 45.  Student Fees-Universities.  (Excluded from state-level budget.)  
- 51.  Retirement Contributions (of ~~individuals~~ and non-state entities).    
- 66.  Proceeds, Investment Maturities.  (Not sustainable flow.)  
- 72.  Bond Issue Proceeds.  (Not sustainable flow.)   
- 75.  Inter-Agency Receipts.  (Except from Funds excluded from Fiscal Futures)  
- 79.  Cook County Intergovernmental Transfers.  (State is not beneficiary.)  
- 98.  Prior Year Refunds.    

**All Other Sources** 

Expanded to include the following smaller sources:  
- 30.  Horse Racing Taxes & Fees.  
- 60.  Other Grants and Contracts.  
- 63.  Investment Income.
- 75.  Inter-Agency Receipts.  __(Only from Funds excluded from Fiscal Futures)__

For aggregating revenue, use the rev_1998_2022 dataframe, join the funds_ab_in_2021 file to it, and then join the ioc_source_type file to the dataset. 

You need to update the funds_ab_in and ioc_source_type file every year! 

> include how to do that later

```{r create-rev-temp, warning = FALSE, message=FALSE}
# fund info to revenue for all years
rev_temp <- inner_join(rev_1998_2022, funds_ab_in_2021, by = "fund") %>% arrange(source)

# need to update the ioc_source_type file every year! 
ioc_source_type <- readxl::read_xlsx("C:/Users/aleaw/OneDrive/Desktop/PhD Fall 2021 - Spring 2022/Merriman RA/Fiscal Futures FY2022/Replication-Files/ioc_source_updated22_AWM.xlsx")

rev_temp <- left_join(rev_temp, ioc_source_type, by = "source")
# automatically used source, source name does not match for the join to work using source_name
```

Update Agencies: Early agencies replaced by successors
```{r agencies-rev}
# recodes old agency numbers to consistent agency number
rev_temp <- rev_temp %>% 
  mutate(agency = case_when(
    (agency=="438"| agency=="475" |agency == "505") ~ "440",
    # financial institution &  professional regulation &
     # banks and real estate  --> coded as  financial and professional reg
    agency == "473" ~ "588", # nuclear safety moved into IEMA
    (agency =="531" | agency =="577") ~ "532", # coded as EPA
    (agency =="556" | agency == "538") ~ "406", # coded as agriculture
    agency == "560" ~ "592", # IL finance authority (fire trucks and agriculture stuff)to state fire marshal
    agency == "570" & fund == "0011" ~ "494",   # city of Chicago road fund to transportation
    TRUE ~ (as.character(agency)))) 
```

```{r create-rev-federal-transfers}
rev_temp <- rev_temp %>% 
  mutate(
    rev_type = ifelse(rev_type=="57" & agency=="478" & (source=="0618"|source=="2364"|source=="0660"|source=="1552"| source=="2306"| source=="2076"|source=="0676"|source=="0692"), "58", rev_type),
    rev_type_name = ifelse(rev_type=="58", "FEDERAL TRANSPORTATION", rev_type_name),
    
    rev_type = ifelse(rev_type=="57" & agency=="494", "59", rev_type),
    rev_type_name = ifelse(rev_type=="59", "FEDERAL TRANSPORTATION", rev_type_name),
    
    rev_type_name = ifelse(rev_type=="57", "FEDERAL OTHER", rev_type_name),
    rev_type = ifelse(rev_type=="6", "06", rev_type),
    rev_type = ifelse(rev_type=="9", "09", rev_type)) 


rev_temp %>% 
  group_by(fy, rev_type_name) %>% 
  summarise(receipts = sum(receipts, na.rm = TRUE)/1000000) %>% pivot_wider(names_from = rev_type_name, values_from = receipts)
```

### Pension Contributions

Employee contributions to pension are a revenue source for the state. In order to get the net cost of  pensions for the state, employee contributions should be subtracted in order to calculate net costs.  

- current year employee revenue source = 0573   
- contributions by employee == 572 (stops at 2011)  


```{r}
#pension_rev_check <- rev_temp %>% filter(source == "0572" | source == "0573" | source == "0574" | source == "0577" | source == "1982" | source == "2567")

#write_csv(pension_rev_check, "pension_revenue_check.csv")


# current year employee revenue source = 0573, contributions by employee == 572 (stops at 2011)
pension_rev <- rev_temp %>% filter(rev_type == "51" & source == "0573" | source == "0572")


rev_type <- anti_join(rev_temp, pension_rev)

pension_rev_yearly <- rev_temp %>% filter(rev_type == "51" & source == "0573" | source == "0572") %>% 
  group_by(fy, rev_type) %>%
  summarise(pension_rev_sum = sum(receipts, na.rm=TRUE)/1000000) %>% select(-rev_type)

```

`pension_rev` should be subtracted from the state pension expenditures. Employee contributions to pensions are a revenue source. We want net pension cost, therefore subtract employee contributions from pension costs. 

### Health Insurance Premiums from Employees

Employee insurance premiums for healthcare are a revenue source for the state. In order to get the true cost of State Employee Healthcare, total employee insurance premiums should be subtracted from the healthcare expenditure total (exp_904 - premiums). Gather all employee premiums into `opt_premiums` and subtract it from the Expenditure table after aggregating and pivoting steps.

0120 = ins prem-option life
0120 = ins prem-optional life/univ

0347 = optional health - HMO
0348 = optional health - dental 
0349 = optional health - univ/local SI
0350 = optional health - univ/local
0351 = optional health - retirement
0352 = optional health - retirement SI
0353 = optional health - retire/dental
0354 = optional health - retirement hmo

2199-2209 = various HMOs, dental, health plans from Health Insurance Reserve (fund)

```{r step-3.6-insurance-premiums}

opt_premiums_CHECK <- rev_temp %>% 
  filter((fund=="0907" | fund == "0457") & (source=="0120" | source=="0121" | (source>"0345" & source<"0357") | (source>"2199" & source<"2209")                                            ) 
         )

#collect optional insurance premiums to fund 0907 for use in eehc expenditure  
rev_temp <- rev_temp %>% 
  mutate(med_option_recent = ifelse(
    fund=="0907" & (source=="0120"| source=="0121"| (source>"0345" & source<"0357")|(source>"2199" & source<"2209")), 1, 0),
    
    # adds more rev_type codes
    rev_type = case_when(
      fund =="0427" ~ "12", # pub utility tax
      fund == "0742" | fund == "0473" ~ "24", # insurance and fees
      fund == "0976" ~ "36",# receipts from rev producing
      fund == "0392" |fund == "0723" ~ "39", # licenses and fees
      fund == "0656" ~ "78", #all other rev sources
      TRUE ~ as.character(rev_type)))
#if not mentioned, then rev_type as it was



# optional insurance premiums = employee insurance premiums
med_option_recent <- rev_temp %>%
  group_by(fy, med_option_recent) %>%
  summarize(med_option_amt_recent = sum(receipts)/1000000) %>%
  filter(med_option_recent == 1) %>%
  rename(year = fy) %>% 
  select(-med_option_recent)

med_option_long <- rev_temp %>%  filter(med_option_recent == 1)
# 361 observations have med_option_recent == 1


rev_temp <- rev_temp %>% filter(med_option_recent != 1)
# could also do an antijoin with rev_temp and med_option dataframes


```

Still need to add med_option data to Other Revenues

Transfers in and Out: 
in_from_out <- c("0847", "0867", "1175", "1176", "1177", "1178", "1181", "1182", "1582", "1592", "1745", "1982", "2174", "2264")

SPORTS FACILITIES TAX TRUST
REPLACEMENT VEHICLE TAX-ST
EASTERN ILLINOIS UNIVERSITY
GOVERNOR'S STATE UNIVERSITY
NORTHEASTERN ILLINOIS UNIV
WESTERN ILLINOIS UNIVERSITY 1579
SOUTHERN ILLINOIS UNIVERSITY 1580
UNIVERSITY OF ILLINOIS 1581
PUBLIC BUILDING FUND 1582
DRYCLEANER TRUST FUND
LOCAL DEBT SERVICE ACCT 1745
STATE EMPLOY RETIREMENT SYSTEM 1982
CHILD SUPPORT ENFORCE TRUST
PROTEST FUND

**I don't have much faith in the transfers in and out steps- AWM**

```{r step-3.8}

rev_temp <- rev_temp %>% 
  filter(in_ff == 1) %>% 
  mutate(local = ifelse(is.na(local), 0, local)) %>%
  filter(local != 1)

# 1175 doesnt exist?
in_from_out <- c("0847", "0867", "1175", "1176", "1177", "1178", "1181", "1182", "1582", "1592", "1745", "1982", "2174", "2264")

# what does this actually include:
in_out_df <- rev_type %>%
  mutate(infromout = ifelse(source %in% in_from_out, 1, 0)) %>%
  filter(infromout == 1)

rev_temp <- rev_temp %>% 
  mutate(rev_type_new = ifelse(source %in% in_from_out, "76", rev_type))
# if source contains any of the codes in in_from_out, code them as 76 (all other rev).

# revenue types to drop
drop_type <- c("32", "45", "51", 
               "66", "72", "75", "79", "98")

# drops Blank, Student Fees, Retirement contributions, proceeds/investments,
# bond issue proceeds, interagency receipts, cook IGT, Prior year refunds.


rev_temp <- rev_temp %>% filter(!rev_type_new %in% drop_type)
# keep observations that do not have a revenue type mentioned in drop_type

table(rev_temp$rev_type_new)

rev_temp %>% 
  group_by(fy, rev_type_new) %>% 
  summarize(total_reciepts = sum(receipts)/1000000) %>%
  pivot_wider(names_from = rev_type_new, values_from = total_reciepts, names_prefix = "rev_") 

# combines smallest 4  categories to to "Other"
# they were the 4 smallest in past years, are they still the 4 smallest? 

rev_temp <- rev_temp %>%  
  mutate(rev_type_new = ifelse(rev_type=="30" | rev_type=="60" | rev_type=="63" | rev_type=="76" | rev_type=="78" , "78", rev_type_new))


#table(rev_temp$rev_type_new)  # check work


rm(rev_1998_2022)
rm(exp_1998_2022)
```


# Aggregating and Merging

- State employee insurance premiums (eehc from eehc2_amt) should be subtracted from state employee healthcare expenditures. State employer group insurance contributions should be dropped to avoid double counting costs.   

- Subtract employee insurance premiums from 904 (State Employee Healthcare Expenditures - Employee Premiums = Actual state healthcare costs. Subtract med_option_amt_recent in med_option_recent from exp_904 in ff_exp). 

- Employee pension contributions should be subtracted from state pension costs. 
  - exp_901 - rev_51? even though rev_type == 51 (retirement contributions) is dropped based on past code. 


- Local Government Transfers (exp_970) should be on the expenditure side

 

## Revenues

```{r final-ffrev-table}
ff_rev <- rev_temp %>% 
  group_by(rev_type_new, fy) %>% 
  summarize(sum_receipts = sum(receipts, na.rm=TRUE)/1000000 ) %>%
  pivot_wider(names_from = "rev_type_new", values_from = "sum_receipts", names_prefix = "rev_")

ff_rev<- left_join(ff_rev, tax_refund)

#ff_rev <- left_join(ff_rev, pension2_fy22, by=c("fy" = "year"))

#ff_rev <- left_join(ff_rev, eehc2_amt) 
ff_rev <- mutate_all(ff_rev, ~replace_na(.,0))


ff_rev <- ff_rev %>%
  mutate(rev_02 = rev_02 - ref_02,
         rev_03 = rev_03 - ref_03,
         rev_06 = rev_06 - ref_06,
         rev_09 = rev_09 - ref_09,
         rev_21 = rev_21 - ref_21,
         rev_24 = rev_24 - ref_24,
         rev_35 = rev_35 - ref_35,

         rev_78new = rev_78 #+ pension_amt #+ eehc
         ) %>% 
  select(-c(ref_02:ref_35, rev_76, rev_78, rev_99, rev_NA#, pension_amt
          #  , eehc
            )) %>%  # drop unwanted columns 
  rowwise() %>% 
  mutate(rev_TOTALS = sum(across(rev_02:rev_78new)))

ff_rev

```


Since I already pivot_wider()ed the table in the previous code chunk, I now change each column's name by using rename() to set new variable names. Ideally the final dataframe would have both the variable name and the variable label but I have not done that yet. 

```{r eval = FALSE, include = FALSE}
stata_labels_rev <- ff_rev %>%
  rename("INDIVIDUAL INCOME TAXES, gross of local, net of refunds" = rev_02,
         "CORPORATE INCOME TAXES, gross of PPRT, net of refunds" = rev_03,
         "SALES TAXES, gross of local share" = rev_06 ,
         "MOTOR FUEL TAX, gross of local share, net of refunds" = rev_09 ,
         "PUBLIC UTILITY TAXES, gross of PPRT" = rev_12,
         "CIGARETTE TAXES" = rev_15 ,
         "LIQUOR GALLONAGE TAXES" = rev_18,
         "INHERITANCE TAX" = rev_21,
         "INSURANCE TAXES&FEES&LICENSES, net of refunds" = rev_24 ,
         "CORP FRANCHISE TAXES & FEES" = rev_27,
      #   "HORSE RACING TAXES & FEES" = rev_30,  # in Other
         "MEDICAL PROVIDER ASSESSMENTS" = rev_31 ,
         # "GARNISHMENT-LEVIES " = rev_32 , # dropped
         "LOTTERY RECEIPTS" = rev_33 ,
         "OTHER TAXES" = rev_35,
         "RECEIPTS FROM REVENUE PRODUCNG" = rev_36, 
         "LICENSES, FEES & REGISTRATIONS" = rev_39 ,
         "MOTOR VEHICLE AND OPERATORS" = rev_42 ,
         #  "STUDENT FEES-UNIVERSITIES" = rev_45,   # dropped
         "RIVERBOAT WAGERING TAXES" = rev_48 ,
         # "RETIREMENT CONTRIBUTIONS " = rev_51, # dropped
         "GIFTS AND BEQUESTS" = rev_54, 
         "FEDERAL OTHER" = rev_57 ,
         "FEDERAL MEDICAID" = rev_58, 
         "FEDERAL TRANSPORTATION" = rev_59 ,
      #   "OTHER GRANTS AND CONTRACTS" = rev_60, #other
       #  "INVESTMENT INCOME" = rev_63, # other
         # "PROCEEDS,INVESTMENT MATURITIES" = rev_66 , #dropped
         # "BOND ISSUE PROCEEDS" = rev_72,  #dropped
         # "INTER-AGENCY RECEIPTS" = rev_75,  #dropped
     #    "TRANSFER IN FROM OUT FUNDS" = rev_76,  #other
         "ALL OTHER SOURCES" = rev_78new ,
         # "COOK COUNTY IGT" = rev_79, #dropped
         # "PRIOR YEAR REFUNDS" = rev_98 #dropped
  ) 

stata_labels_rev

# Still contains columns that should be dropped for the clean final aggregate table. Drop the variables I don't want in the output table in the "graphs" section.  

```



## Expenditures

- Create exp_930 for the cost of debt interest

- Create state employee healthcare costs that reflects the health costs minus the insurance premiums paid by employees that came in (904_new = healthcare_cost - med_option_amt_recent).

- Create exp_901_new for pensions that reflect employees pension contributions. Subtract employee contributions from pension costs (exp_901 - pension_rev_sum).

- Create exp_970 for all local government transfers (exp_971 + exp_972  + exp_975 + exp_976).

```{r}

ff_exp <- exp_temp %>% 
  group_by(fy, group) %>% 
  summarize(sum_expenditures = sum(expenditure, na.rm=TRUE)/1000000 ) %>%
  pivot_wider(names_from = "group", values_from = "sum_expenditures", names_prefix = "exp_")%>%
  
    left_join(debt_keep_yearly) %>%
  mutate(exp_903 = debt_cost) %>%

    left_join(healthcare_costs_yearly) %>%

  # join state employee healthcare and subtract employee premiums
  left_join(med_option_recent, by = c("fy" = "year")) %>%
  mutate(exp_904_new = (`healthcare_cost` - `med_option_amt_recent`)) %>% # state employee healthcare premiums
  
  left_join(pension_rev_yearly) %>%
      mutate(exp_901_new = exp_901 - pension_rev_sum) %>% #employee pension contributions


  # join local transfers and create exp_970
  left_join(transfers) %>%
  mutate(exp_970 = exp_971 + exp_972  + exp_975 + exp_976)

ff_exp<- ff_exp %>% 
  select(-c(exp_901, med_option_amt_recent, debt_cost, healthcare_cost, pension_rev_sum, exp_971:exp_976)) %>%  # drop unwanted columns 
  rowwise() %>% 
  mutate(exp_TOTALS = sum(across(exp_402:exp_970)))


```

- after aggregating expenditures and revenues, pivoting wider, and left_joining the additional mini dataframes (med_option_recent, debt_keep_yearly, pension_rev_yearly, healthcare_costs_yearly, & transfers), then I dropped the columns that I no longer want in my final tables. I also added a TOTALS column by summing across the columns. 

# Graphs!

In order to graph data in different ways, it is helpful to have data in both wide and long formats. 

The chunk below creates the long format data of the recoded observations for expenditures and revenues (`exp_long` and `rev_long`). The category names are all upper case and long and based on Stata labels. Nearly all expenditure categories and revenue sources are still separate in this stage. Later on, the largest ten-ish to fifteen-ish categories are kept separate and the the remaining smaller expenditure and revenue categories are aggregated to "All Other ______" for final summary tables that are used in the Fiscal Futures paper. 

Our rough rule of thumb was to keep categories larger than $2 billion but that is not a strict rule at all.  The other goal was to replicate tables from past years to allow for comparability over time. 

```{r rev-exp-totals-long}

###### clean revenue data in long format ####

# take ff_rev and pivot it wider so that all of the revenue sources are in one column and all values are in one column (Category and Dollars, respectively)
# then apply labels  based on Stata code

rev_long <- pivot_longer(ff_rev, rev_02:rev_TOTALS, names_to = c("type","Category"), values_to = "Dollars", names_sep = "_") %>% 
  rename(Year = fy) %>%
  filter(Year < 2022) %>%
  mutate(Category_name = case_when(
    Category == "02" ~ "INDIVIDUAL INCOME TAXES, gross local, net refunds" ,
    Category == "03" ~ "CORPORATE INCOME TAXES, gross of PPRT, net of refunds" ,
    Category == "06" ~ "SALES TAXES, gross of local share" ,
    Category == "09" ~ "MOTOR FUEL TAX, gross of local share, net of refunds" ,
    Category == "12" ~ "PUBLIC UTILITY TAXES, gross of PPRT" ,
    Category == "15" ~ "CIGARETTE TAXES" ,
    Category == "18" ~ "LIQUOR GALLONAGE TAXES" ,
    Category == "21" ~ "INHERITANCE TAX" ,
    Category == "24" ~ "INSURANCE TAXES&FEES&LICENSES, net of refunds " ,
    Category == "27" ~ "CORP FRANCHISE TAXES & FEES" ,
    Category == "30" ~ "HORSE RACING TAXES & FEES",  # in Other
    Category == "31" ~ "MEDICAL PROVIDER ASSESSMENTS" ,
    Category == "32" ~ "GARNISHMENT-LEVIES" , # dropped
    Category == "33" ~  "LOTTERY RECEIPTS" ,
    Category == "35" ~  "OTHER TAXES" ,
    Category == "36" ~  "RECEIPTS FROM REVENUE PRODUCNG", 
    Category == "39" ~  "LICENSES, FEES & REGISTRATIONS" ,
    Category == "42" ~  "MOTOR VEHICLE AND OPERATORS" ,
    Category == "45" ~  "STUDENT FEES-UNIVERSITIES",   # dropped
    Category == "48" ~  "RIVERBOAT WAGERING TAXES" ,
    Category == "51" ~  "RETIREMENT CONTRIBUTIONS" , # dropped
    Category == "54" ~ "GIFTS AND BEQUESTS", 
    Category == "57" ~  "FEDERAL OTHER" ,
    Category == "58" ~  "FEDERAL MEDICAID", 
    Category == "59" ~  "FEDERAL TRANSPORTATION" ,
    Category == "60" ~  "OTHER GRANTS AND CONTRACTS", #other
    Category == "63" ~  "INVESTMENT INCOME", # other
    Category == "66" ~ "PROCEEDS,INVESTMENT MATURITIES" , #dropped
    Category == "72" ~ "BOND ISSUE PROCEEDS",  #dropped
    Category == "75" ~  "INTER-AGENCY RECEIPTS ",  #dropped
    Category == "76" ~  "TRANSFER IN FROM OUT FUNDS",  #other
    Category == "78new" ~  "ALL OTHER SOURCES" ,
    Category == "79" ~   "COOK COUNTY IGT", #dropped
    Category == "98" ~  "PRIOR YEAR REFUNDS", #dropped
    Category == "TOTALS"~ "Total Revenue",
                 T ~ "Check Me!"

  ) )


###### clean expenditure data in long format ####

# pivot ff_exp longer so that the only variables are Year, type, Category, Category_name, and Dollars
exp_long <- pivot_longer(ff_exp, exp_402:exp_TOTALS , names_to = c("type", "Category"), values_to = "Dollars", names_sep = "_") %>% 
  rename(Year = fy ) %>% 
    filter(Year < 2022) %>%

  mutate(Category_name = 
           case_when(
             Category == "402" ~ "AGING" ,
             Category == "406" ~ "AGRICULTURE", 
             Category == "416" ~ "CENTRAL MANAGEMENT",
             Category == "418" ~ "CHILDREN AND FAMILY SERVICES", 
             Category == "420" ~ "COMMERCE AND ECONOMIC OPPORTUNITY",
             Category == "422" ~ "NATURAL RESOURCES" ,
             Category == "426" ~ "CORRECTIONS",
             Category == "427" ~ "EMPLOYMENT SECURITY" ,
             Category == "444" ~ "HUMAN SERVICES" ,
             Category == "448" ~ "Innovation and Technology", # AWM added fy2022
             Category == "478" ~ "HEALTHCARE & FAM SER NET OF MEDICAID", 
             Category == "482" ~ "PUBLIC HEALTH", 
             Category == "492" ~ "REVENUE", 
             Category == "494" ~ "TRANSPORTATION" ,
             Category == "532" ~ "ENVIRONMENTAL PROTECT AGENCY" ,
             Category == "557" ~ "IL STATE TOLL HIGHWAY AUTH" ,
             Category == "684" ~ "IL COMMUNITY COLLEGE BOARD", 
             Category == "691" ~ "IL STUDENT ASSISTANCE COMM" ,
             Category == "900" ~ "NOT IN FRAME",
             Category == "901" ~ "STATE PENSION CONTRIBUTION",
             Category == "903" ~ "DEBT SERVICE",
             Category == "904" ~ "State Employee Healthcare",
             Category == "910" ~ "LEGISLATIVE"  ,
             Category == "920" ~ "JUDICIAL" ,
             Category == "930" ~ "ELECTED OFFICERS" , 
             Category == "940" ~ "OTHER HEALTH-RELATED", 
             Category == "941" ~ "PUBLIC SAFETY" ,
             Category == "942" ~ "ECON DEVT & INFRASTRUCTURE" ,
             Category == "943" ~ "CENTRAL SERVICES",
             Category == "944" ~ "BUS & PROFESSION REGULATION" ,
             Category == "945" ~ "MEDICAID" ,
             Category == "946" ~ "CAPITAL IMPROVEMENT" , 
             Category == "948" ~ "OTHER DEPARTMENTS" ,
             Category == "949" ~ "OTHER BOARDS & COMMISSIONS" ,
             Category == "959" ~ "K-12 EDUCATION" ,
             Category == "960" ~ "UNIVERSITY EDUCATION",
             Category == "970" ~ "Local Govt Transfers",
           Category == "TOTALS" ~ "Total Expenditure",
             T ~ "CHECK ME!")
           )
# uncomment to write long format data as CSVs for inspecting work

 # write_csv(exp_long, "expenditures_recoded_long_FY22.csv")
 # write_csv(rev_long, "revenue_recoded_long_FY22.csv")


###### All data combined into one long format. Can be easily pivoted in R or Excel by type and Category Name. #####

aggregated_totals_long <- rbind(rev_long, exp_long) %>% filter(Category!= "TOTALS")


year_totals <- aggregated_totals_long %>% 
  group_by(type, Year) %>% 
  summarize(Dollars = sum(Dollars, na.rm = TRUE)) %>% 
  pivot_wider(names_from = "type", values_from = Dollars) %>% 
  rename(
         Expenditures = exp,
         Revenue = rev) %>%  
  mutate(Gap = Revenue - Expenditures) %>% arrange(-Year)
# creates variable for the Gap each year

year_totals


```

After pivoting_longer() and creating `rev_long` and `exp_long`, expenditures and revenues are in the same format and can be combined together for the totals and gap each year.

```{r stata-labels, eval=FALSE, include=FALSE}


## Stata labels for Francis. 
## Needed old column names to be identical and in same order.


stata_labels_rev <- pivot_longer(ff_rev, rev_02:rev_TOTALS, names_to = c("type","Category"), values_to = "Dollars", names_sep = "_") %>% 
  rename(year = fy) %>%
  filter(year <2022) %>%
  mutate(Category_name = case_when(
    Category == "02" ~ "INDIVIDUAL INCOME TAXES, gross of local, net of refunds ($ mil.)" ,
    Category == "03" ~ "CORPORATE INCOME TAXES, gross of PPRT, net of refunds ($ mil.)" ,
    Category == "06" ~ "SALES TAXES, gross of local share ($ mil.)" ,
    Category == "09" ~ "MOTOR FUEL TAX, gross of local share, net of refunds ($ mil.)" ,
    Category == "12" ~ "PUBLIC UTILITY TAXES, gross of PPRT ($ mil.)" ,
    Category == "15" ~ "CIGARETTE TAXES ($ mil.)" ,
    Category == "18" ~ "LIQUOR GALLONAGE TAXES ($ mil.)" ,
    Category == "21" ~ "INHERITANCE TAX ($ mil.)" ,
    Category == "24" ~ "INSURANCE TAXES&FEES&LICENSES, net of refunds ($ mil.)" ,
    Category == "27" ~ "CORP FRANCHISE TAXES & FEES ($ mil.)" ,
    Category == "30" ~ "HORSE RACING TAXES & FEES",  # in Other
    Category == "31" ~ "MEDICAL PROVIDER ASSESSMENTS ($ mil.)" ,
    Category == "32" ~ "GARNISHMENT-LEVIES" , # dropped
    Category == "33" ~  "LOTTERY RECEIPTS ($ mil.)" ,
    Category == "35" ~  "OTHER TAXES ($ mil.)" ,
    Category == "36" ~  "RECEIPTS FROM REVENUE PRODUCNG ($ mil.)", 
    Category == "39" ~  "LICENSES, FEES & REGISTRATIONS ($ mil.)" ,
    Category == "42" ~  "MOTOR VEHICLE AND OPERATORS ($ mil.)" ,
    Category == "45" ~  "STUDENT FEES-UNIVERSITIES",   # dropped
    Category == "48" ~  "RIVERBOAT WAGERING TAXES ($ mil.)" ,
    Category == "51" ~  "RETIREMENT CONTRIBUTIONS" , # dropped
    Category == "54" ~ "GIFTS AND BEQUESTS ($ mil.)", 
    Category == "57" ~  "FEDERAL OTHER ($ mil.)" ,
    Category == "58" ~  "FEDERAL MEDICAID ($ mil.)", 
    Category == "59" ~  "FEDERAL TRANSPORTATION ($ mil.)" ,
    Category == "60" ~  "OTHER GRANTS AND CONTRACTS", #other
    Category == "63" ~  "INVESTMENT INCOME", # other
    Category == "66" ~ "PROCEEDS,INVESTMENT MATURITIES" , #dropped
    Category == "72" ~ "BOND ISSUE PROCEEDS",  #dropped
    Category == "75" ~  "INTER-AGENCY RECEIPTS ",  #dropped
    Category == "76" ~  "TRANSFER IN FROM OUT FUNDS",  #other
    Category == "78new" ~  "ALL OTHER SOURCES, adjusted ($ mil.)" ,
    Category == "79" ~   "COOK COUNTY IGT", #dropped
    Category == "98" ~  "PRIOR YEAR REFUNDS", #dropped
    Category == "TOTALS"~ "Total",
                 T ~ "Check Me!"

  ) )

# take the revenue with labels that match the Stata output and write it to a csv:
stata_labels_rev %>% select(c(-type, -Category)) %>% pivot_wider(names_from = "Category_name", values_from = "Dollars") %>% write_csv("stata_labels_rev.csv")


# stata labels for expenditures:
stata_labels_exp <- pivot_longer(ff_exp, exp_402:exp_TOTALS , names_to = c("type", "Category"), values_to = "Dollars", names_sep = "_") %>% 
  rename(year = fy ) %>% 
    filter(year < 2022) %>%
  mutate(Category_name = 
           case_when(
             Category == "402" ~ "AGING ($ mil.)" ,
             Category == "406" ~ "AGRICULTURE ($ mil.)", 
             Category == "416" ~ "CENTRAL MANAGEMENT ($ mil.)",
             Category == "418" ~ "CHILDREN AND FAMILY SERVICES ($ mil.)", 
             Category == "420" ~ "COMMERCE AND ECONOMIC OPPORTUNITY ($ mil.)",
             Category == "422" ~ "NATURAL RESOURCES ($ mil.)" ,
             Category == "426" ~ "CORRECTION ($ mil.)S",
             Category == "427" ~ "EMPLOYMENT SECURITY ($ mil.)" ,
             Category == "444" ~ "HUMAN SERVICES ($ mil.)" ,
             Category == "478" ~ "HEALTHCARE & FAM SER NET OF MEDICAID ($ mil.)", 
             Category == "482" ~ "PUBLIC HEALTH ($ mil.)", 
             Category == "492" ~ "REVENUE ($ mil.)", 
             Category == "494" ~ "TRANSPORTATION ($ mil.)" ,
             Category == "532" ~ "ENVIRONMENTAL PROTECT AGENCY ($ mil.)" ,
             Category == "557" ~ "IL STATE TOLL HIGHWAY AUTH ($ mil.)" ,
             Category == "684" ~ "IL COMMUNITY COLLEGE BOARD ($ mil.)", 
             Category == "691" ~ "IL STUDENT ASSISTANCE COMM ($ mil.)" ,
             Category == "901" ~ "STATE PENSION CONTRIBUTION ($ mil.)",
             Category == "903" ~ "DEBT SERVICE ($ mil.)",
             Category == "904" ~ "STATE EMPLOYEE HEALTHCARE ($ mil.)",
             Category == "910" ~ "LEGISLATIVE ($ mil.)"  ,
             Category == "920" ~ "JUDICIAL ($ mil.)" ,
             Category == "930" ~ "ELECTED OFFICERS ($ mil.)" , 
             Category == "941" ~ "PUBLIC SAFETY ($ mil.)" ,
         #    Category == "942" ~ "ECON DEVT & INFRASTRUCTURE" ,
             Category == "944" ~ "BUS & PROFESSION REGULATION ($ mil.)" ,
             Category == "945" ~ "MEDICAID ($ mil.)" ,
             Category == "946" ~ "CAPITAL IMPROVEMENT ($ mil.)" , 
             Category == "948" ~ "OTHER DEPARTMENTS ($ mil.)" ,
             Category == "949" ~ "OTHER BOARDS & COMMISSIONS ($ mil.)" ,
             Category == "959" ~ "K-12 EDUCATION ($ mil.)" ,
             Category == "960" ~ "UNIVERSITY EDUCATION ($ mil.)",
             Category == "970" ~ "LOCAL GOVT REVENUE SHARE ($ mil.)",
           Category == "TOTALS" ~ "Total",
             T ~ "Other")
           )

# save expenditure data with Stata labels as csv file
stata_labels_exp %>% select(-c(type, Category)) %>% pivot_wider(names_from = Category_name, values_from = Dollars) %>% write_csv("stata_labels_exp.csv")

# check to make sure they still match if you use this! 

```


Graphs made from  `yearly_totals` and `aggregated_totals_long` dataframe: 

```{r}
year_totals %>%  
  ggplot() +
  # geom_smooth adds regression line, graphed first so it appears behind line graph
  geom_smooth(aes(x = Year, y = Revenue), color = "light green", method = "lm", se = FALSE) + 
  geom_smooth(aes(x = Year, y = Expenditures), color = "gray", method = "lm", se = FALSE) +
  
  # line graph of revenue and expenditures
  geom_line(aes(x = Year, y = Revenue), color = "green4") +
  geom_line(aes(x = Year, y = Expenditures), color = "black") +
  
  # labels
    theme_bw() +
  scale_y_continuous(labels = comma)+
  xlab("Year") + 
  ylab("Millions of Dollars")  +
  ggtitle("Illinois Expenditures and Revenue Totals, 1998-2022")
```


```{r include=FALSE, eval=FALSE}
aggregated_totals_long %>%  
  filter(type == "exp") %>% # uses only expenditures
  ggplot(aes(x = Year, y = Dollars, group = Category, color = Category)) +
  geom_line()+
    xlab("Year") + 
    ylab("Millions of Dollars")  +
    ggtitle("Illinois Expenditures by Category")

aggregated_totals_long %>%  
  filter(type == "rev") %>% #uses only revenues
  ggplot(aes(x = Year, y = Dollars, group = Category, color = Category)) +
  geom_line()+
    xlab("Year") + 
    ylab("Millions of Dollars")  +
    ggtitle("Illinois Revenues by Category")
  
```

**Expenditure and revenue amounts in millions of dollars:** 
```{r}

### **Expenditure and revenue amounts in millions of dollars:** 

exp_long %>%
  filter(Year == 2021 & Category_name != "Total Expenditure") %>%
  #mutate(`Total Expenditures`= sum(Dollars, na.rm = TRUE)) %>%
 # select(-c(Year, `Total Expenditures`)) %>%
  arrange(desc(`Dollars`)) %>%
  ggplot() + 
  geom_col(aes(x = fct_reorder(Category_name, `Dollars`), y = `Dollars`))+ 
  coord_flip() +
      theme_bw() +
  labs(title = "Expenditures for FY2021") +
    xlab("Expenditure Categories") +
  ylab("Millions of Dollars") 

rev_long %>%
  filter(Year == 2021 & Category_name != "Total Revenue") %>%
  #mutate(`Total Expenditures`= sum(Dollars, na.rm = TRUE)) %>%
 # select(-c(Year, `Total Expenditures`)) %>%
  arrange(desc(`Dollars`)) %>%
  ggplot() + 
  geom_col(aes(x = fct_reorder(Category_name, `Dollars`), y = `Dollars`))+ 
  coord_flip() +
    theme_bw() +
      labs(title = "Revenues for FY2021")+
    xlab("Revenue Categories") +
  ylab("Millions of Dollars") 

```


```{r eval = FALSE, include = FALSE}

### All categories included in column graph

exp_long %>%
  filter(Year == 2021) %>%
  #mutate(`Total Expenditures`= sum(Dollars, na.rm = TRUE)) %>%
 # select(-c(Year, `Total Expenditures`)) %>%
  arrange(desc(`Dollars`)) %>%
  ggplot() + 
  geom_col(aes(x = fct_reorder(Category, `Dollars`), y = `Dollars`))+ 
  coord_flip() +
    labs(title = "Expenditures for FY2021") +
    xlab("Expenditure Categories") +
  ylab("Millions of Dollars") +
    theme_bw()

rev_long %>%
  filter(Year == 2021) %>%
  #mutate(`Total Expenditures`= sum(Dollars, na.rm = TRUE)) %>%
 # select(-c(Year, `Total Expenditures`)) %>%
  arrange(desc(`Dollars`)) %>%
  ggplot() + 
  geom_col(aes(x = fct_reorder(Category, `Dollars`), y = `Dollars`))+ 
  coord_flip() +
    xlab("Revenue Categories") +
  ylab("Millions of Dollars") +
    theme_bw()
```


**Expenditure and revenues when focusing on largest categories and combining others into "All Other Expenditures(Revenues)":**

```{r}
## Code is for top largest categories

exp_long %>%
  filter( Year == 2021 & Category_name != "Total Expenditure") %>%
  mutate(rank = rank(Dollars),
         # keep 13 largest Categories separate and combine the rest
        Category_name = ifelse(rank > 13, Category_name, 'All Other Expenditures')) %>%
 # select(-c(Year, Dollars, rank)) %>%
  arrange(desc(Dollars)) %>%
  ggplot() + 
  geom_col(aes(x = fct_reorder(Category_name, `Dollars`), y = `Dollars`), fill = "light green")+ 
  coord_flip() +
      theme_bw() +
    labs(title = "Expenditures for FY2021") +
    xlab("") +
  ylab("Millions of Dollars")

rev_long %>%
  filter( Year == 2021 & Category_name != "Total Revenue") %>%
  mutate(rank = rank(Dollars),
         # Keeps 10 largest categories and combines the rest
        Category_name = ifelse(rank > 10, Category_name, 'All Other Revenues')) %>%
 # select(-c(Year, Dollars, rank)) %>%
  arrange(desc(Dollars)) %>%
  ggplot() + 
  geom_col(aes(x = fct_reorder(Category_name, `Dollars`), y = `Dollars`), fill = "light blue")+ 
  coord_flip() +
      theme_bw() +
    labs(title = "Revenues for FY2021") +
    xlab("") +
  ylab("Millions of Dollars")
```


```{r eval = FALSE, include = FALSE}

# **Keeping the top 13 categories and grouping the rest to All Other Expenditures(Revenues). 
# Shown as a percentage of total expenditures(revenues)**


exp_long %>%
  filter( Year == 2021) %>%
  mutate(`Total Expenditures` = sum(Dollars, na.rm = TRUE),
        `Percent of Total Expenditures` = round((Dollars / `Total Expenditures`*100), 2),
        rank = rank(-Dollars),
        Category = ifelse(rank <= 13, Category, 'All Other Expenditures')) %>%
  select(-c(Year, `Total Expenditures`, rank)) %>%
  arrange(desc(`Percent of Total Expenditures`)) %>%

  ggplot() + 
  geom_col(aes(x = fct_reorder(Category, `Percent of Total Expenditures`), y = `Percent of Total Expenditures`), fill = "light green")+ 
  coord_flip() +
    xlab("") +
      ylab("Percent of Total Expenditure") +
    theme_bw()


exp_long %>%
  filter( Year == 2021) %>%
  mutate(`Total Expenditures` = sum(Dollars, na.rm = TRUE),
        `Percent of Total Expenditures` = round((Dollars / `Total Expenditures`*100), 2),
        rank = rank(-Dollars),
        Category_name = ifelse(rank <= 13, Category_name, 'All Other Expendiures')) %>%
  select(-c(Year, `Total Expenditures`, rank)) %>%
  arrange(desc(`Percent of Total Expenditures`)) %>%

  ggplot() + 
  geom_col(aes(x = fct_reorder(Category_name, `Percent of Total Expenditures`), y = `Percent of Total Expenditures`), fill = "light green")+ 
  coord_flip() +
  xlab("")+
    ylab("Percent of Total Expenditure") +
    theme_bw()


```

# Summary Tables - All Categories

Each year, you will need to update the CAGR formulas! 

`calc_cagr` is a function created for calculating the CAGRs for different spans of time. 

```{r CAGR-expenditures}
 
# function for calculating the CAGR
calc_cagr <- function(df, n) {
  df <- exp_long %>%
    select(-type) %>%
    arrange(Category_name, Year) %>%
    group_by(Category_name) %>%
    mutate(cagr = ((`Dollars` / lag(`Dollars`, n)) ^ (1 / n)) - 1)

  return(df)
}

# This works for one variable at a time
cagr_23 <- calc_cagr(exp_long, 23) %>% 
  # group_by(Category) %>%
  summarize(cagr_23 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr23_precovid <- exp_long %>%
  filter(Year <= 2019) %>%
  calc_cagr(21) %>% 
  summarize(cagr_21 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr23_midcovid <- exp_long %>%
  filter(Year <= 2019) %>%
  calc_cagr(21) %>% 
  summarize(cagr_21 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr_10 <- calc_cagr(exp_long, 10) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_10 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_5 <- calc_cagr(exp_long, 5) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_5 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_3 <- calc_cagr(exp_long, 3) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_3 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_2 <- calc_cagr(exp_long, 2) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_2 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_1 <- calc_cagr(exp_long, 1) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_1 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

CAGR_expenditures_summary_allcats <- data.frame(cagr_1, cagr_2, cagr_3, cagr_5, cagr_10, cagr_23 ) %>% 
  select(-c(Category_name.1, Category_name.2, Category_name.3, Category_name.4, Category_name.5 )) %>% 
  rename("Expenditure Category" = Category_name, "1 Year CAGR" = cagr_1, "2 Year CAGR" = cagr_2, "3 Year CAGR" = cagr_3, "5 Year CAGR" = cagr_5, "10 Year CAGR" = cagr_10,"23 Year CAGR" = cagr_23 )

CAGR_expenditures_summary_allcats
CAGR_expenditures_summary_allcats %>% 
  kbl(caption = "CAGR Calculations for Expenditures") %>% 
  kable_styling(bootstrap_options = c("striped"))


expenditure_change_allcats <- exp_long %>%
  select(-c(type,Category)) %>%
  filter(Year > 2019) %>%
  pivot_wider(names_from = Year , values_from = Dollars,   names_prefix = "Dollars_") %>%
  mutate("FY 2021 Expenditures ($ billions)" = round(Dollars_2021/1000, digits = 1),
  #  "Change from 2020 to 2021" = Dollars_2021 - Dollars_2020,
         "Percent Change from 2020 to 2021" = round((Dollars_2021 -Dollars_2020)/Dollars_2020*100, digits = 2) )%>%
  left_join(CAGR_expenditures_summary_allcats, by = c("Category_name" = "Expenditure Category")) %>% 
  arrange(-`FY 2021 Expenditures ($ billions)`)%>%
  select(-c(Dollars_2020, Dollars_2021, `1 Year CAGR`:`10 Year CAGR`)) %>%
  rename( "Compound Annual Growth, 1998-2021*" = `23 Year CAGR`, 
          "FY2021 Expenditure Category" = Category_name ) 

#kableExtra::kable(expenditure_change_allcats)

#expenditure_change_allcats

expenditure_change_allcats %>% 
  kbl(caption = "Change in Expenditures") %>% kable_styling(bootstrap_options = c("striped"))

```

```{r CAGR-revenues}
  
calc_cagr <- function(df, n) {
  df <- rev_long %>%
    arrange(Category_name, Year) %>%
    group_by(Category_name) %>%
    mutate(cagr = ((Dollars / lag(Dollars, n)) ^ (1 / n)) - 1)

  return(df)
}

# This works for one variable at a time
cagr_23 <- calc_cagr(rev_long, 23) %>% 
  summarize(cagr_23 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr_10 <- calc_cagr(rev_long, 10) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_10 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_5 <- calc_cagr(rev_long, 5) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_5 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_3 <- calc_cagr(rev_long, 3) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_3 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_2 <- calc_cagr(rev_long, 2) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_2 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

 cagr_1 <- calc_cagr(rev_long, 1) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_1 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

CAGR_revenue_summary_allcats <- data.frame(cagr_1, cagr_2, cagr_3, cagr_5, cagr_10, cagr_23) %>%   
  select(-c(Category_name.1, Category_name.2, Category_name.3, Category_name.4, Category_name.5 )) %>% 
  rename("Revenue Category" = Category_name, "1 Year CAGR" = cagr_1, "2 Year CAGR" = cagr_2, "3 Year CAGR" = cagr_3, "5 Year CAGR" = cagr_5, "10 Year CAGR" = cagr_10,"23 Year CAGR" = cagr_23 )

CAGR_revenue_summary_allcats %>% 
  kbl(caption = "CAGR Calculations for Revenues") %>% 
  kable_styling(bootstrap_options = c("striped"))

revenue_change_allcats <- rev_long %>%
  select(-c(type,Category)) %>%
  filter(Year > 2019) %>%
  pivot_wider(names_from = Year , values_from = Dollars,   names_prefix = "Dollars_") %>%
  mutate(
    "FY 2021 Revenues ($ billions)" = round(Dollars_2021/1000, digits = 1),
#    "Change from 2020 to 2021" = round(Dollars_2021 - Dollars_2020, digits = 2),
         "Percent Change from 2020 to 2021" = round(((Dollars_2021 -Dollars_2020)/Dollars_2020*100), digits = 2)) %>%
  left_join(CAGR_revenue_summary_allcats, by = c("Category_name" = "Revenue Category")) %>% 
    arrange(-`FY 2021 Revenues ($ billions)`)%>%
  rename( "Compound Annual Growth, 1998-2021*" = `23 Year CAGR`, 
          "FY2021 Revenue Category" = Category_name ) %>%
  select(-c(Dollars_2020, Dollars_2021, `1 Year CAGR`:`10 Year CAGR`))

revenue_change_allcats %>% 
  kbl(caption = "Revenue Change") %>% 
  kable_styling(bootstrap_options = c("striped"))

```

Another way to examine expenditure and revenue change over time is to use a lag formula like is done in the chunk below.  Should be kind of similar to 23 year CAGR. 

**Expenditure and Revenue Growth using a lag formula:**
```{r growth-check}
 exp_long %>% 
  group_by(Category_name) %>% 
  mutate(Growth = ((Dollars) - lag(Dollars))/lag(Dollars) *100) %>% 
  summarize(Growth = round(mean(Growth, na.rm = TRUE), 2))

 rev_long %>% 
  group_by(Category_name) %>% 
  mutate(Growth = ((Dollars) - lag(Dollars))/lag(Dollars) *100) %>% 
  summarize(Growth = round(mean(Growth, na.rm = TRUE), 2))
```


# Summary Tables - Largest Categories

The 10 largest revenue sources and 13 largest expenditure sources remain separate categories and all other smaller sources/expenditures are combined into "All Other _____". These condensed tables are typically used in the Fiscal Futures articles. They were manually created in past years but this hopefully automates the process a bit until final formatting stages. 


- take ff_rev and ff_exp data frames, which were in wide format, pivot them longer and mutate the Category_name variable to nicer labels. Keep largest categories separate and aggregate the rest. 

```{r wide-summary-tables}

revenue_wide <- pivot_longer(ff_rev, rev_02:rev_TOTALS, names_to = c("type","Category"), values_to = "Dollars", names_sep = "_") %>% 
  rename(Year = fy) %>%
  filter(Year <2022) %>%

  mutate(Category_name = case_when(
    Category == "02" ~ "Income Tax" ,
    Category == "03" ~ "Corporate Income Tax" ,
    Category == "06" ~ "Sales Tax" ,
    Category == "09" ~ "Motor Fuel Taxes" ,
 #   Category == "12" ~ "PUBLIC UTILITY TAXES, gross of PPRT" ,
  #  Category == "15" ~ "CIGARETTE TAXES" ,
 #   Category == "18" ~ "LIQUOR GALLONAGE TAXES" ,
 #  Category == "21" ~ "INHERITANCE TAX" ,
  #  Category == "24" ~ "INSURANCE TAXES&FEES&LICENSES, net of refunds " ,
   # Category == "27" ~ "CORP FRANCHISE TAXES & FEES" ,
 #   Category == "30" ~ "HORSE RACING TAXES & FEES",  # in Other
    Category == "31" ~ "Medical Provider Assessments" ,
  #  Category == "32" ~ "GARNISHMENT-LEVIES" , # dropped
  #  Category == "33" ~  "LOTTERY RECEIPTS" ,
   # Category == "35" ~  "OTHER TAXES" ,
    Category == "36" ~  "Receipts from Revenue Producing", 
    Category == "39" ~  "Licenses, Fees, Registration" ,
   # Category == "42" ~  "MOTOR VEHICLE AND OPERATORS" ,
#    Category == "45" ~  "STUDENT FEES-UNIVERSITIES",   # dropped
#    Category == "48" ~  "RIVERBOAT WAGERING TAXES" ,
  #  Category == "51" ~  "RETIREMENT CONTRIBUTIONS" , # dropped
   # Category == "54" ~ "GIFTS AND BEQUESTS", 
    Category == "57" ~  "Federal Other" ,
    Category == "58" ~  "Federal Medicaid Reimbursements", 
    Category == "59" ~  "Federal Transportation" ,
 #   Category == "60" ~  "OTHER GRANTS AND CONTRACTS", #other
#    Category == "63" ~  "INVESTMENT INCOME", # other
 #   Category == "66" ~ "PROCEEDS,INVESTMENT MATURITIES" , #dropped
 #   Category == "72" ~ "BOND ISSUE PROCEEDS",  #dropped
 #   Category == "75" ~  "INTER-AGENCY RECEIPTS ",  #dropped
 #   Category == "76" ~  "TRANSFER IN FROM OUT FUNDS",  #other
   # Category == "78new" ~  "ALL OTHER SOURCES" ,
   # Category == "79" ~   "COOK COUNTY IGT", #dropped
 #   Category == "98" ~  "PRIOR YEAR REFUNDS", #dropped
                
Category == "TOTALS" ~ "Total Revenue",
T ~ "Other Revenue Sources **" # any other Category number that was not specifically referenced is cobined into Other Revenue Sources

  ) ) %>% 
  select(-type, -Category) %>%  # drop extra columns type and Category number
  group_by(Year, Category_name) %>%
  summarise(Dollars= round(sum(Dollars),digits=2)) 

# revenue_wide # not actually in wide format yet. 
# has 10 largest rev sources separate and combined all others to Other in long data format. 


# creates wide version of table where each revenue source is a column
revenue_wide2 <- revenue_wide %>% pivot_wider(names_from = Category_name, 
              values_from = Dollars) %>%
  relocate("Other Revenue Sources **", .after = last_col()) %>%
  relocate("Total Revenue", .after =  last_col())



#### example for pivoting the other way:
# has Category Names as rows and years as columns. Easier to read source variable labels

# revenue_wide %>% pivot_wider(names_from = Year, values_from = Dollars) %>% select(Category_name, '2021')
```


```{r wide-summary-table-expenditure}
expenditure_wide <- pivot_longer(ff_exp, exp_402:exp_TOTALS , names_to = c("type", "Category"), values_to = "Dollars", names_sep = "_") %>% 
  rename(Year = fy ) %>% 
    filter(Year < 2022) %>%

  mutate(Category_name = 
           case_when(
            # Category == "402" ~ "AGING" ,
           #  Category == "406" ~ "AGRICULTURE", 
             Category == "416" ~ "Central Management",
            # Category == "418" ~ "CHILDREN AND FAMILY SERVICES", 
             Category == "420" ~ "Community Development",
           #  Category == "422" ~ "NATURAL RESOURCES" ,
            # Category == "426" ~ "CORRECTIONS",
           #  Category == "427" ~ "EMPLOYMENT SECURITY" ,
             Category == "444" ~ "Human Services" ,
           #  Category == "478" ~ "HEALTHCARE & FAM SER NET OF MEDICAID", 
           #  Category == "482" ~ "PUBLIC HEALTH", 
           #  Category == "492" ~ "REVENUE", 
             Category == "494" ~ "Transportation" ,
           #  Category == "532" ~ "ENVIRONMENTAL PROTECT AGENCY" ,
             Category == "557" ~ "Tollway" ,
           #  Category == "684" ~ "IL COMMUNITY COLLEGE BOARD", 
            # Category == "691" ~ "IL STUDENT ASSISTANCE COMM" ,
           #  Category == "900" ~ "NOT IN FRAME",
             Category == "901" ~ "State Pension Contribution",
             Category == "903" ~ "Debt Service",
             Category == "904" ~ "State Employee Healthcare",
           #  Category == "910" ~ "LEGISLATIVE"  ,
          #   Category == "920" ~ "JUDICIAL" ,
          #   Category == "930" ~ "ELECTED OFFICERS" , 
            # Category == "940" ~ "OTHER HEALTH-RELATED", 
             Category == "941" ~ "Public Safety" ,
           #  Category == "942" ~ "ECON DEVT & INFRASTRUCTURE" ,
           #  Category == "943" ~ "CENTRAL SERVICES",
           #  Category == "944" ~ "BUS & PROFESSION REGULATION" ,
             Category == "945" ~ "Medicaid" ,
             Category == "946" ~ "Capital Improvement" , 
           #  Category == "948" ~ "OTHER DEPARTMENTS" ,
            # Category == "949" ~ "OTHER BOARDS & COMMISSIONS" ,
             Category == "959" ~ "K-12 Education" ,
           #  Category == "960" ~ "UNIVERSITY EDUCATION",
             Category == "970" ~ "Local Govt Revenue Sharing",
          Category == "TOTALS" ~ "Total Expenditure",
             T ~ "All Other Expenditures **")
           ) %>% 
  select(-type, -Category) %>% 
  group_by(Year, Category_name) %>% 
  summarise(Dollars= round(sum(Dollars),digits=2))

expenditure_wide2 <- expenditure_wide%>% 
  pivot_wider(names_from = Category_name, 
              values_from = Dollars) %>%
  relocate("All Other Expenditures **", .after = last_col()) %>%
  relocate("Total Expenditure", .after =  last_col())

expenditure_wide %>% pivot_wider(names_from = Year, 
              values_from = Dollars)

```

Before I created the CAGR values for all categories and sources. Now we want CAGR values for the aggregated "All Other __" group. We have to recalculate the 23 year CAGR and then left_join it to our top ten sources and top 13-ish expenditures:


If we want Tables 4a and 4b for the Fiscal Futures paper to match the categories used in Table 1 and 2, then we want to calculate the CAGR values for the combined expenditure and revenue sources. The CAGR/Growth section above calculates values for all categories. 

### Top 13 Expenditures
```{r CAGR-expenditures2}
 

# CAGR values for largest expenditure categories and combined All Other Expenditures

calc_cagr <- function(df, n) {
  df <- expenditure_wide %>% # actually in long form, not wide yet. expenditure_wide2 is wide version
    arrange(Category_name, Year) %>%
    group_by(Category_name) %>%
    mutate(cagr = ((`Dollars` / lag(`Dollars`, n)) ^ (1 / n)) - 1)

  return(df)
}

cagr_23 <- calc_cagr(expenditure_wide, 23) %>% 
    filter(Year == 2021) %>% # keeps cagr calculations for fy2021 only, the rest are NAs
  summarize(cagr_23 = round(sum(cagr*100, na.rm = TRUE), 2))


cagr22_midcovid <- expenditure_wide %>% 
  filter(Year <=2020) %>%
  calc_cagr(22) %>%
  filter(Year == 2020) %>%
  summarize(cagr_22 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr21_precovid <- expenditure_wide %>% 
  filter( Year <=2019) %>% 
  calc_cagr(21) %>%
 filter(Year == 2019) %>%
  summarize(cagr_21 = case_when(Year == 2019 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_10 <- calc_cagr(expenditure_wide, 10) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_10 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_5 <- calc_cagr(expenditure_wide, 5) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_5 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_3 <- calc_cagr(expenditure_wide, 3) %>% 
 filter(Year == 2021) %>%
  summarize(cagr_3 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_2 <- calc_cagr(expenditure_wide, 2) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_2 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_1 <- calc_cagr(expenditure_wide, 1) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_1 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

CAGR_expenditures_summary_majorcats <- data.frame(cagr_1, cagr_2, cagr_3, cagr_5, cagr_10, cagr21_precovid, cagr22_midcovid, cagr_23 ) %>% 
  select(-c(Category_name.1, Category_name.2, Category_name.3, Category_name.4, Category_name.5, Category_name.6, Category_name.7 )) %>% 
  rename("Expenditure Category" = Category_name, 
         "1-year CAGR" = cagr_1, "2-year CAGR" = cagr_2, "3-year CAGR" = cagr_3, 
         "5-year CAGR" = cagr_5, "10-year CAGR" = cagr_10, 
         "Pre-COVID* 21-year CAGR"  = cagr_21, "Mid-COVID** 22-year CAGR" = cagr_22,
         "23-year CAGR" = cagr_23 )

CAGR_expenditures_summary_majorcats %>% 
  kbl(caption = "CAGR Calculations for Largest Expenditures Categories") %>% 
  kable_styling(bootstrap_options = c("striped"))
#CAGR_expenditures_summary_majorcats %>% write_csv("CAGR_expenditures_summary_majorcats.csv")



# Yearly change for Top 13 largest expenditure categories
expenditure_change2 <- expenditure_wide %>%
  filter(Year > 2019) %>%
  pivot_wider(names_from = Year , values_from = Dollars,   names_prefix = "Dollars_") %>%
  mutate("FY 2021 Expenditures ($ billions)" = round(Dollars_2021/1000, digits = 1),
  #  "Change from 2020 to 2021" = Dollars_2021 - Dollars_2020,
         "Percent Change from 2020 to 2021" = round((Dollars_2021 -Dollars_2020)/Dollars_2020*100, digits = 2) ) %>%
  left_join(cagr_23) %>%  # add long term CAGR
  arrange(-`FY 2021 Expenditures ($ billions)`)%>%
  select(-c(Dollars_2020, Dollars_2021)) %>%
  rename( "Compound Annual Growth, 1998-2021*" = `cagr_23`, 
          "FY2021 Expenditure Category" = Category_name) 

expenditure_change2 %>% 
  kbl(caption = "Expenditure Change for Largest Categories") %>% 
  kable_styling(bootstrap_options = c("striped"))



expenditure_wide %>%  
  filter(Category_name!= "Total Expenditure") %>%
  ggplot(aes(x = Year, y = Dollars, group = Category_name, color=Category_name)) +
  geom_line()+
    xlab("Year") + 
    ylab("Millions of Dollars")  +
    ggtitle("Largest Expenditure Categories - Illinois Fiscal Year 2021")

```

### Top 10 Revenue Sources
Top 10 revenue sources CAGRs and Yearly Change Tables:
```{r }

##### Top 10 revenue CAGRs: ####
# calculate just the 23 year cagr for our Yearly Change table that has the long run CAGR
calc_cagr <- function(df, n) {
  df <- revenue_wide %>% # actually in long format still but has small groups combined together
    arrange(Category_name, Year) %>%
    group_by(Category_name) %>%
    mutate(cagr = ((`Dollars` / lag(`Dollars`, n)) ^ (1 / n)) - 1)

  return(df)
}

cagr_23 <- calc_cagr(revenue_wide, 23) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_23 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr_22midcovid <- revenue_wide %>%  
  filter(Year<=2020) %>% # bases calculations off of fy2020
  calc_cagr(22) %>%      # then does cagr calculation
  filter(Year==2020) %>% # gets rid of NAs for other years
  summarize(cagr_22 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr_21precovid <- revenue_wide %>% 
  filter(Year <= 2019) %>% #makes sure 2019 is the last year
  calc_cagr(21) %>%          # then does cagr calculation
  filter(Year==2019) %>%
  summarize(cagr_21 = round(sum(cagr*100, na.rm = TRUE), 2))

cagr_10 <- calc_cagr(revenue_wide, 10) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_10 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_5 <- calc_cagr(revenue_wide, 5) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_5 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_3 <- calc_cagr(revenue_wide, 3) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_3 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

cagr_2 <- calc_cagr(revenue_wide, 2) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_2 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

 cagr_1 <- calc_cagr(revenue_wide, 1) %>% 
  filter(Year == 2021) %>%
  summarize(cagr_1 = case_when(Year == 2021 ~ round(sum(cagr*100, na.rm = TRUE), 2)))

CAGR_revenue_summary_majorcats <- data.frame(cagr_1, cagr_2, cagr_3, cagr_5, cagr_10, cagr_21precovid, cagr_22midcovid , cagr_23) %>%   
  select(-c(Category_name.1, Category_name.2, Category_name.3, Category_name.4, Category_name.5, Category_name.6, Category_name.7 )) %>% 
  rename("Revenue Category" = Category_name, 
         "1-year CAGR" = cagr_1, "2-year CAGR" = cagr_2, 
         "3-year CAGR" = cagr_3, "5-year CAGR" = cagr_5,
         "10-year CAGR" = cagr_10,
         "Pre-COVID* 21-year CAGR"  = cagr_21, "Mid-COVID** 22-year CAGR" = cagr_22,
         "23-year CAGR" = cagr_23 )

CAGR_revenue_summary_majorcats %>% 
  kbl(caption = "CAGR Calculations for Major Revenue Sources") %>% 
  kable_styling(bootstrap_options = c("striped"))

CAGR_revenue_summary_majorcats %>% write_csv("CAGR_revenue_summary_majorcats.csv")


###### Yearly change summary table for Top 10 Revenues #####
revenue_change2 <- revenue_wide %>%
  filter(Year > 2019) %>%
  pivot_wider(names_from = Year , values_from = Dollars,   names_prefix = "Dollars_") %>%
  mutate(
    "FY 2021 Revenues ($ billions)" = round(Dollars_2021/1000, digits = 1),
#    "Change from 2020 to 2021" = round(Dollars_2021 - Dollars_2020, digits = 2),
         "Percent Change from 2020 to 2021" = round(((Dollars_2021 -Dollars_2020)/Dollars_2020*100), digits = 2)) %>%
  left_join(cagr_23) %>% 
    arrange(-`FY 2021 Revenues ($ billions)`) %>%
  rename( "Compound Annual Growth, 1998-2021*" = `cagr_23`, # give nice labels for table output
          "FY2021 Revenue Category" = Category_name ) %>%
  select(-c(Dollars_2020, Dollars_2021)) 

revenue_change2 %>% 
  kbl(caption = "Change in Major Revenue Sources") %>% 
  kable_styling(bootstrap_options = c("striped"))

revenue_wide %>%  
  filter(Category_name != "Total Revenue") %>% #uses only revenues
  ggplot(aes(x = Year, y = Dollars, group = Category_name, color = Category_name)) +
  geom_line()+
    xlab("Year") + 
    ylab("Millions of Dollars")  +
    ggtitle("Top Revenue Sources - Illinois Fiscal Year 2021")




  


           
```



### Export Summary Files
Saves main items in one excel file named `summary_file.xlsx`. Delete `eval=FALSE` to run on local computer.

```{r}
#install.packages("openxlsx")
library(openxlsx)

dataset_names <- list('Aggregate Revenues' = revenue_wide2, # Top Categories aggregated, nice labels
                      'Aggregate Expenditures' = expenditure_wide2, 

                      
                      'Table 1' = expenditure_change2, #Top categories with yearly change, 23 yr cagr
                      'Table 2' = revenue_change2,
                      
                      'Table 4.a' = CAGR_revenue_summary_majorcats, # Categories Match Table 1 in paper
                      'Table 4.b' = CAGR_expenditures_summary_majorcats, 
                                            
                      'Table 1-AllCats' = expenditure_change_allcats,  # All Categories by Year
                      'Table 2-AllCats' = revenue_change_allcats,
                      
                      'Table 4.a-AllCats' = CAGR_revenue_summary_allcats, 
                      'Table 4.b-AllCats' = CAGR_expenditures_summary_allcats, 
                      
                      'year_totals' = year_totals,    # Total Revenue, Expenditure, and Fiscal gap per year
                      
                      'aggregated_totals_long' = aggregated_totals_long # all data in long format. Good for creating pivot tables in Excel
                      )

write.xlsx(dataset_names, file = 'summary_file_FY21_FINAL.xlsx')
```


